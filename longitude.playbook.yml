#
# $ make playbook
#
# This playbook has been tested with Ubuntu 16.04 and Ansible 2.7.
#
- hosts: [127.0.0.1]
  connection: local

  vars:

    dpkg_query: "dpkg-query --show --showformat='${db:Status-Status}\n' '%s' | grep '^installed'"

    firefox_unofficial_extensions:
      bypass-paywalls: # See https://github.com/iamadamdev/bypass-paywalls-firefox/releases
        url: "https://github.com/iamadamdev/bypass-paywalls-firefox/releases/download/v%(version)s/bypass_paywalls-%(version)s-an+fx.xpi"
        version: 1.5.1
        checksum: "md5:8937de9f94d350abf532d585e2f22df5"
      browser-mpris2: # See https://github.com/otommod/browser-mpris2/issues/11#issuecomment-493687444
        url: "https://github.com/CBiX/browser-mpris2/releases/download/v%(version)s-%(commit)s/browser-mpris2-%(commit)s-signed-firefox-fh.cbix.de.xpi"
        version: 0.1-20190518
        commit: 7f11327
        checksum: "md5:1e827d98b8d23ff52f9a4669c8e83252"
        native:
          name: "org.mpris.browser_host"
          allowed_extensions: ["browser-mpris2-%(commit)s-signed-fh@cbix.de"]
          type: "stdio"
          url: "https://raw.githubusercontent.com/otommod/browser-mpris2/%(commit)s/native/chrome-mpris2"
          checksum: "md5:71af835e0d424e629645feb62c8173e3"
          path: "~/bin/chrome-mpris2"
          mode: "+x"

    # See https://github.com/mozilla/policy-templates/blob/master/README.md
    #
    firefox_policies:
      policies:
        DisableTelemetry: true
        DisablePocket: true
        DNSOverHTTPS:
          Enabled: true
          ProviderURL: "https://mozilla.cloudflare-dns.com/dns-query"
          Locked: true
        Certificates:
          ImportEnterpriseRoots: true
          Install:
            - InfoNotaryQualifiedLegalPersonSealCA.pem
            - InfoNotaryQualifiedPersonalSignCA.pem
            - InfoNotaryQualifiedTimeStampingServiceCA.pem
            - InfoNotaryQualifiedValidatedDomainCA.pem
            - InfoNotaryQualifiedValidationServicesCA.pem
            - InfoNotaryTSPRoot.pem
        SecurityDevices:
          Bit4Id: "/usr/lib/libbit4ipki.so"
        Extensions:
          Install: "{%
            set extensions = []
          %}{%
            for name, extension in firefox_unofficial_extensions | dictsort
          %}{%
              set _ = extensions.extend([ \"/usr/local/lib/firefox/extensions/\" + name + \"-\" + extension.version + (\"-\" + extension.commit if \"commit\" in extension else \"\") + \"-unofficial.xpi\" ])
          %}{%
            endfor
          %}{{ extensions }}"

    # See https://support.mozilla.org/en-US/kb/customizing-firefox-using-autoconfig
    #
    # See https://hg.mozilla.org/mozilla-central/file/tip/browser/app/profile/firefox.js
    #     https://hg.mozilla.org/mozilla-central/file/6663d3dc883b6ad0d0dfa9346f9ceabf2b2c7967/browser/app/profile/firefox.js (April 2020)
    #
    firefox_about_config:
      # Usability & quality of life improvements
      #
      "mousewheel.acceleration.start": 10 # Wait for two mouse wheel scrolls before enabling acceleration,
      "mousewheel.acceleration.factor": 5 # Accelerate by this much for each mouse wheel scroll.
      "browser.urlbar.update1": false # Don't use the new URL bar which looks like an annoying pop up (Firefox 75+).
      "browser.urlbar.update1.interventions": false #  If true, Firefox shows actionable tips in the URL bar when the user is searching for those actions.
      "browser.urlbar.update1.searchTips": false # If true, Firefox shows new users and those about to start an organic search a tip encouraging them to use the URL bar.
      "browser.urlbar.update1.view.stripHttps": false # Don't strip https:// from URL suggestions (Firefox 75+).
      "browser.urlbar.openViewOnFocus": false # Don't open the URL bar drop-down immediately on focus (Firefox 75+).
      "browser.urlbar.trimURLs": false # Force Firefox to always show https:// and www. terms for URLs in address bar.
      # Development
      #
      "devtools.chrome.enabled": true # This enables Ctrl+Alt+Shift+J as well as the command entry in Ctrl+Shift+J.
      # Security
      #
      # See https://web.archive.org/web/20190410203751/https://www.internetsociety.org/blog/2018/12/dns-privacy-support-in-mozilla-firefox/
      #
      "network.trr.mode": 3
      "network.trr.bootstrapAddress": "1.1.1.1"
      "network.security.esni.enabled": true
      "privacy.firstparty.isolate": true
      # Network
      #
      "network.dns.disableIPv6": true # We don't use or need IPv6.
      # Caching
      #
      "browser.cache.disk.enable": false # Don't trash my SSD!
      "browser.cache.disk.parent_directory": "/tmp/.mozilla/cache/firefox" # If we ever re-enable disk caching, use tmpfs.
      "browser.cache.memory.enable": true
      "browser.cache.memory.capacity": 8192000 # 8GB
      "browser.cache.memory.max_entry_size": 10240 # 10MB
      # Experimental
      #
      "gfx.webrender.all": true
      "media.videocontrols.picture-in-picture.enabled": true # https://web.archive.org/web/20191203233905/https://css-tricks.com/an-introduction-to-the-picture-in-picture-web-api/#article-header-id-0

    firefox_locales: [en, bg]

    waterfox_version: 2020.02
    waterfox_release: linux64
    waterfox_platform: linux-x86_64
    waterfox_locale: en-US
    waterfox_checksum: "sha256:a3b5d62078fad09bd165d54af9c73d6928891aafab65d2cd7916eac19e6d6980"

    mailspring_version: 1.7.4
    mailspring_platform: amd64
    mailspring_checksum: 'sha256:7c92cdc93151c293fe2e4975be3668c950dbb4dec492f5c955136dccee96a12d'

    neovim_version: 0.4.3
    neovim_checksum: "sha256:a3b7ccbde583acdc7f3385025d3c5e386f92aa97e425b311a49402836998b4e0"
    neovim_dictionaries: [bg.utf-8]

    git_lfs_gpg_key_id: "DC282033"

    python_version: '3.8.0'

    ruby_version: '2.6.5'

    docker_gpg_key_id: "0EBFCD88"
    docker_platform: amd64
    docker_compose_version: 1.25.4
    docker_compose_checksum: "sha256:542e93b1d5106d2769b325f60ba9a0ba087bb96e30dc2c1cb026f0cb642e9aed"
    docker_machine_version: 0.16.1
    docker_machine_checksum: "sha256:44a008c14549156222b314b1448c22ef255b446419fcf96570f3f288dff318a9"
    docker_machine_drivers:
      linode: { url: "https://github.com/linode/docker-machine-driver-%(name)s/releases/download/v%(version)s/docker-machine-driver-%(name)s_linux-amd64.zip", version: 0.1.8, checksum: "sha256:b31b6a504c59ee758d2dda83029fe4a85b3f5601e22dfa58700a5e6c8f450dc7" }

    gnupg_conf:
      use-agent: ''
      charset: 'UTF-8'
      default-key: '595EA753'
    gnupg_agent_conf:
      enable-ssh-support: ''
      pinentry-program: '/usr/bin/pinentry-gnome3'
      default-cache-ttl: 3600
      max-cache-ttl: 7200

    authy_desktop_version: 1.8.0
    authy_desktop_checksum: "md5:2612c816ae5ea59ecfbbaef02e26830b"

    android_studio_build: 183.5692245
    android_studio_version: 3.4.2.0
    android_studio_checksum: "sha256:35eb8c74837d1aab59229101fc91568a607ac04854a40209f7a0ba7ac0601924"
    android_home: /opt/android/sdk

    dropbox_version: 2019.01.31
    dropbox_platform: amd64

    keybase_platform: amd64

    tarsnap_version: 1.0.39

    imagemagick_version: 7.0.10-6
    imagemagick_checksum: "sha256:30ac7ce423cef9fb7baf0aefc734ae7b2593b9499c3782057ab73b7a360a0ac5"

    youtube_dl_version: 2019.04.30
    youtube_dl_checksum: "sha256:3c7f9192f93405bca7f68fd944a08f3bad5274ac90007cf423edb2fb779d382b"

    fd_version: 7.5.0
    fd_platform: amd64
    fd_checksum: "sha256:0def65ac4a0158209112c3df2522a853b439743740d422af2c16c994398b3cd7"

    ripgrep_version: 0.10.0
    ripgrep_platform: amd64
    ripgrep_checksum: "sha256:fae8c9dbe17998ce7d426bd3649fe71fd7c9eef0e9c2ac85e5958e2a70f665b8"

    pup_version: 0.4.0
    pup_platform: linux_amd64
    pup_checksum: "sha256:ec3d29e9fb375b87ac492c8b546ad6be84b0c0b49dab7ff4c6b582eac71ba01c"

    jq_version: 1.6
    jq_platform: linux64
    jq_checksum: "sha256:af986793a515d500ab2d35f8d2aecd656e764504b789b66d7e1a0b727a124c44"

    httpie_version: 2.0.0
    httpie_plugins:
      - { name: 'httpie-oauth', version: 1.0.2 }

    awscli_version: '>1.16'

    fzf_version: 0.17.5
    fzf_platform: linux_amd64
    fzf_checksum: "sha256:3020c7d4d43d524ff394df306337b6de873b9db0bd9cd9dc73cd80cbd6e0c2f8"

    bat_version: 0.10.0
    bat_platform: amd64
    bat_checksum: "md5:7b21d6d7d42493440d0c51d3b64947c8"

    xidel_version: 0.9.8-1
    xidel_platform: amd64
    xidel_checksum: "sha256:f6a6e29b77547d5ae38383440bd653b3eaf9eeb470def14cc48154a4f6925f69"

    # See https://dl.equinox.io/ngrok/ngrok/stable/archive
    ngrok_version: 2.3.18
    ngrok_platform: linux-amd64
    ngrok_stable_channel_id: 8jFoSpgnjgu
    ngrok_checksum: "sha256:3e4f39dd3130b80dd0a736182712952100fcc462a0eb4d9ca15e50668c9d3862"

    ffsend_version: 0.2.37
    ffsend_platform: linux-x64
    ffsend_checksum: "sha256:9c6ba0596c0f65d5f70fb96f5a51426ae03f3baa44be803e34fd26755f327d69"

    terraform_version: 0.12.9
    terraform_checksum: "sha256:69712c6216cc09b7eca514b9fb137d4b1fead76559c66f338b4185e1c347ace5"
    terraform_platform: linux_amd64
    terraform_plugins:
      terraform-provider-mailgunv3: { url: "https://github.com/phillbaker/terraform-provider-mailgunv3/releases/download/v%(version)s/%(name)s_v%(version)s_%(platform)s", version: 0.3.2, checksum: "md5:ec780c1c15898253e599fbadfacf17f0" } # See https://github.com/phillbaker/terraform-provider-mailgunv3/releases

    zsh_version: 5.7.1
    zsh_checksum: "md5:374f9fdd121b5b90e07abfcad7df0627"

    rxvt_unicode_version: 9.22
    rxvt_unicode_cvs_date: "2020-04-01"
    rxvt_unicode_patches: [
      { url: "https://gist.githubusercontent.com/StanAngeloff/743c1cbb7566b5f0d84aeb41503bb989/raw/60b3755868282052c9842c0bf8c71e5dcf51280a/rxvt-unicode-clipboard.patch", checksum: "sha256:fef02e5498d65703910d1205780681a8b828df09e418e676d26192664c91a4d4" }
    ]
    rxvt_unicode_configure_args: [
      --enable-256-color,
      --enable-combining,
      --enable-fading,
      --enable-font-styles,
      --enable-iso14755,
      --enable-keepscrolling,
      --enable-lastlog,
      --enable-mousewheel,
      --enable-next-scroll,
      --enable-perl,
      --enable-pointer-blank,
      --enable-rxvt-scroll,
      --enable-selectionscrolling,
      --enable-slipwheeling,
      --disable-smart-resize,
      --enable-startup-notification,
      --enable-transparency,
      --enable-unicode3,
      --enable-utmp,
      --enable-wtmp,
      --enable-xft,
      --enable-xim,
      --enable-xterm-scroll,
      --disable-pixbuf,
      --disable-frills
    ]

    tmux_version: 3.0a
    tmux_checksum: "sha256:4ad1df28b4afa969e59c08061b45082fdc49ff512f30fc8e43217d7b0e5f8db9"

    tig_version: 2.5.0
    tig_checksum: "sha256:ff537c67af9201e7e7276ce8a0ff9961e9d9c6a8a78790f5817124bd7755aef4"

    envchain_version: 1.0.1
    envchain_checksum: "sha256:09af1fe1cfba3719418f90d59c29c081e1f22b38249f0110305b657bd306e9ae"

    pam_google_authenticator_version: 1.06
    pam_google_authenticator_checksum: "sha256:52f03ec746e8deb1af37911697d096f0fa87583491b7cc460cdf09a6ef0d6b06"

    sshd_host_keys: [ed25519, rsa, ecdsa]
    sshd_config:
      Port: 2022
      ListenAddress: '0.0.0.0'
      LoginGraceTime: 30
      PasswordAuthentication: 'no'
      ChallengeResponseAuthentication: 'yes'
      X11Forwarding: 'no'
      # See https://wiki.mozilla.org/Security/Guidelines/OpenSSH
      #
      # The Modern (OpenSSH 6.7+) profile is used.
      #
      KexAlgorithms: 'curve25519-sha256@libssh.org,ecdh-sha2-nistp521,ecdh-sha2-nistp384,ecdh-sha2-nistp256,diffie-hellman-group-exchange-sha256'
      Ciphers: 'chacha20-poly1305@openssh.com,aes256-gcm@openssh.com,aes128-gcm@openssh.com,aes256-ctr,aes192-ctr,aes128-ctr'
      MACs: 'hmac-sha2-512-etm@openssh.com,hmac-sha2-256-etm@openssh.com,umac-128-etm@openssh.com,hmac-sha2-512,hmac-sha2-256,umac-128@openssh.com'
      # See https://wiki.archlinux.org/index.php/OpenSSH#Two-factor_authentication_and_public_keys
      AuthenticationMethods: 'publickey keyboard-interactive:pam'
      # LogLevel VERBOSE logs user's key fingerprint on login. Needed to have a clear audit track of which key was using to log in.
      LogLevel: VERBOSE
      # Log sftp level file access (read/write/etc.) that would not be easily logged otherwise.
      Subsystem: 'sftp /usr/lib/ssh/sftp-server -f AUTHPRIV -l INFO'
      # Root login is not allowed for auditing reasons. This is because it's difficult to track which process belongs to which root user:
      #
      # On Linux, user sessions are tracking using a kernel-side session id, however, this session id is not recorded by OpenSSH.
      # Additionally, only tools such as systemd and auditd record the process session id.
      # On other OSes, the user session id is not necessarily recorded at all kernel-side.
      # Using regular users in combination with /bin/su or /usr/bin/sudo ensure a clear audit track.
      PermitRootLogin: 'no'
      # Use kernel sandbox mechanisms where possible in unprivileged processes
      # Systrace on OpenBSD, Seccomp on Linux, seatbelt on MacOSX/Darwin, rlimit elsewhere.
      UsePrivilegeSeparation: sandbox

    mosh_version: 1.3.2
    mosh_checksum: "sha256:da600573dfa827d88ce114e0fed30210689381bbdcff543c931e4d6a2e851216"

    php_version: 7.2
    php_extensions: [bcmath, curl, gd, gmp, intl, json, mbstring, mysql, pgsql, sqlite3, xml, zip]

    nodesource_gpg_key_id: "68576280"
    nodejs_version: 8

    wine_gpg_key_id: "F987672F"
    playonlinux_gpg_key_id: "8E3D6C3A"

    qemu_version: 4.0.0
    qemu_checksum: "sha256:13a93dfe75b86734326f8d5b475fde82ec692d5b5a338b4262aeeb6b0fa4e469"

    ffmpeg_version: 4.1.4
    ffmpeg_platform: amd64
    ffmpeg_checksum: "md5:d5828f8cc093812041570860c50d5a28"

    tesseract_languages: [eng, bul]

    rambox_version: 0.7.5
    rambox_platform: linux-x86_64
    rambox_checksum: "sha256:0a486f5b4720af537a2e8d2022209223f45b6627fc72b6c86d3985eba882e1bd"

    steam_launcher_version: 1.0.0.61
    steam_launcher_checksum: "sha256:5e7d3f1cb1de847f31152998bdc8137855a1a0f7b0dc099db6a7f4d7e33fd911"

    fraidycat_version: 1.1.3
    fraidycat_checksum: "sha256:a818f9bd90906bd1491ee14d9f97b6a2977a8b0985ec4b0aef0941310eeca114"

    ufw_policy:
      - { direction: incoming, policy: deny }
      - { direction: outgoing, policy: allow }

    ufw_rules:
      - { rule: allow, comment: 'Allow Docker containers to communicate with host services/1.', direction: in, from_ip: '172.16.0.0/12', proto: tcp, to_port: 3030 }

  handlers:
    - { name: "ufw::restart", become: yes, service: { name: ufw, state: restarted } }
    - { name: "sshd::restart", become: yes, service: { name: ssh, state: restarted } }
    - { name: "bluetooth::restart", become: yes, service: { name: bluetooth, state: restarted } }

  tasks:

  - { name: "Prerequisites: Paths writeable by the user", become: yes, file: { path: "{{ item }}", owner: "{{ ansible_user_id }}" }, with_items: ["/usr/local/bin", "/opt"] }

  # 9. sudo password is required each time
  - { name: "System: sudo timeout", become: yes, copy: { content: "# Prompt for a password on every escalation.\nDefaults timestamp_timeout=0\n", dest: "/etc/sudoers.d/timeout", force: no, validate: "visudo -cf %s" } }

  # 10. tmpfs at /tmp
  - { name: "System: Make /tmp a tmpfs", become: yes, lineinfile: { path: "/etc/fstab", regexp: "\\/tmp\\s", line: "tmpfs /tmp tmpfs rw,nosuid,nodev,size=4G 0 0" } }

  # 15. i386 is needed for Wine.
  - { name: "System: Add dpkg architectures", become: yes, lineinfile: { dest: "/var/lib/dpkg/arch", line: "{{ item }}", create: yes }, with_items: [amd64, i386] }
  - { name: "System: Update apt cache", become: yes, apt: { update_cache: yes, cache_valid_time: "{{ 24 * 60 * 60 }}" } }

  # 20. build-essential & a few more packages are essential
  - { name: "System: Install essentials", become: yes, apt: { pkg: [build-essential, unzip], state: present } }

  # 30. sysctl
  - { name: "Tweak kernel parameters (sysctl)", become: yes, sysctl: { name: "{{ item.name }}", state: "{{ item.state | default('present') }}", value: "{{ item.value }}", sysctl_file: '/etc/sysctl.d/60-longitude.conf', reload: yes }, when: "ansible_env.IS_DOCKERIZED | default(0) != '1'", tags: [sysctl], with_items: [
      { name: fs.inotify.max_user_watches, value: 524288 },
    ] }

  # 50. Hardware tweaks
  #
  # See https://web.archive.org/web/20200331074851/https://www.spinics.net/lists/linux-bluetooth/msg47685.html
  #
  - { name: "Bluetooth: Check if service installed", stat: { path: "/etc/bluetooth/input.conf" }, register: bluetooth_input_stat, tags: [bluetooth] }
  - name: "Bluetooth: Tweak input configuration"
    become: yes
    ini_file:
      path: "/etc/bluetooth/input.conf"
      no_extra_spaces: true
      section: "{{ item.option.split('/')[:-1]|join('.') }}"
      option: "{{ item.option.split('/')[-1] }}"
      value: "{{ item.value }}"
      state: present
    with_items:
      - { option: "General/UserspaceHID", value: "true" }
    notify: "bluetooth::restart"
    when: bluetooth_input_stat.stat.exists
    tags: [bluetooth]

  # 100. Git
  - { name: "Git: Add PPA", become: yes, apt_repository: { repo: "ppa:git-core/ppa", update_cache: yes }, tags: [git] }
  - { name: "Git: Install packages", become: yes, apt: { pkg: [git, git-gui, gitk], state: present }, tags: [git] }
  # 110. Git LFS
  - { name: "Git: Install Git LFS prerequisites", become: yes, apt: { pkg: [gnupg, curl, debian-archive-keyring, apt-transport-https], state: present }, tags: [git] }
  - { name: "Git: Import Git LFS GPG key", become: yes, apt_key: { id: "{{ git_lfs_gpg_key_id }}", url: "https://packagecloud.io/github/git-lfs/gpgkey" }, tags: [git] }
  - { name: "Git: Add Git LFS repository", become: yes, apt_repository: { repo: "deb https://packagecloud.io/github/git-lfs/ubuntu/ {{ ansible_distribution_release }} main", update_cache: yes }, tags: [git] }
  - { name: "Git: Install Git LFS packages", become: yes, apt: { pkg: [git-lfs], state: present }, tags: [git] }
  - { name: "Git: Install git-extras packages", become: yes, apt: { pkg: [git-extras], state: present }, tags: [git] }
  # 120. git-crypt
  - { name: "Git: Install git-crypt packages", become: yes, apt: { pkg: [git-crypt], state: present }, tags: [git] }
  # 130. Git contrib tools
  - { name: "Git: Capture installed version", shell: "git --version | cut -d' ' -f3", register: git_installed_version, changed_when: no, tags: [git] }
  - { name: "diff-highlight: Check installation", become: yes, command: "ls /usr/local/bin/diff-highlight-{{ git_installed_version.stdout }}", register: git_diff_highlight_install_query, changed_when: no, failed_when: no, tags: [git] }
  - name: "diff-highlight: Compile contrib script"
    become: yes
    when: "git_diff_highlight_install_query.rc > 0"
    shell: |
      rm -rf /tmp/git-src &&
      git clone --depth 1 --branch 'v{{ git_installed_version.stdout }}' https://github.com/git/git.git /tmp/git-src &&
      cd /tmp/git-src/contrib/diff-highlight &&
      make clean diff-highlight &&
      cp diff-highlight /usr/local/bin/diff-highlight-{{ git_installed_version.stdout }}
    tags: [git]
  - { name: "diff-highlight: Set up alternatives", become: yes, alternatives: { name: 'diff-highlight', link: '/usr/local/bin/diff-highlight', path: '/usr/local/bin/diff-highlight-{{ git_installed_version.stdout }}' }, tags: [git] }

  # 200. Python
  - { name: "Python: Install pip packages & Python development headers", become: yes, apt: { pkg: [python-dev, python-pip, python3-dev, python3-pip], state: present }, tags: [python] }
  - { name: "Python: Install virtualenv", become: yes, pip: { executable: pip3, name: virtualenv, state: present }, tags: [python] }
  - { name: "Python: Install prerequisites", become: yes, apt: { pkg: [zlib1g-dev, libncurses5-dev, libgdbm-dev, libnss3-dev, libssl-dev, libreadline-dev, libffi-dev, libsqlite3-dev, libbz2-dev, liblzma-dev, uuid-dev], state: present }, tags: [python] }
  - { name: "Python: Check local installation", become: yes, command: "ls /opt/python{{ python_version.split('.')[:2]|join('.') }}", register: python_install_query, changed_when: no, failed_when: no, tags: [python] }
  - { name: "Python: Download package and signature", get_url: { url: "{{ item }}", dest: "/tmp/{{ item | basename }}" }, when: "python_install_query.rc > 0", tags: [python], with_items: [
      "https://www.python.org/ftp/python/{{ python_version }}/Python-{{ python_version }}.tar.xz",
      "https://www.python.org/ftp/python/{{ python_version }}/Python-{{ python_version }}.tar.xz.asc"
    ] }
  - { name: "Python: Check package signature", command: "gpg --status-fd 1 --no-default-keyring --keyring '{{ ansible_env.PWD }}/keys/python-Lukasz-Langa-keybase.asc.gpg' --verify /tmp/Python-{{ python_version }}.tar.xz.asc", when: "python_install_query.rc > 0", tags: [python] }
  - name: "Python: Compile & install local package"
    when: "python_install_query.rc > 0"
    shell: |
      cd /tmp &&
      tar --overwrite -Jxf 'Python-{{ python_version }}.tar.xz' &&
      cd 'Python-{{ python_version }}' &&
      ./configure --prefix='/opt/python{{ python_version.split('.')[:2]|join('.') }}' --enable-optimizations && make -j8 && make install
    tags: [python]
  - { name: "Python: Set up alternatives", become: yes, alternatives: { name: "{{ item | format(version=python_version.split('.')[:2]|join('.')) }}", link: "/usr/local/bin/{{ item | format(version=python_version.split('.')[:2]|join('.')) }}", path: "/opt/python{{ python_version.split('.')[:2]|join('.') }}/bin/{{ item | format(version=python_version.split('.')[:2]|join('.')) }}" }, tags: [python], with_items: [
      '2to3-%(version)s',
      'easy_install-%(version)s',
      'idle%(version)s',
      'pip%(version)s',
      'pydoc%(version)s',
      'python%(version)s',
      'python%(version)s-config'
    ] }
  - { name: "Python: Install local virtualenv", pip: { executable: "/opt/python{{ python_version.split('.')[:2]|join('.') }}/bin/pip3", name: virtualenv, state: present }, tags: [python] }

  # 250. Ruby
  - { name: "Ruby: Create directories", file: { path: "/opt/rubies", state: directory }, tags: [ruby] }
  - { name: "Ruby: rbenv: Check installation", command: "ls {{ ansible_env.HOME }}/.rbenv/bin/rbenv", register: ruby_rbenv_install_query, changed_when: no, failed_when: no, tags: [ruby] }
  - { name: "Ruby: rbenv: Run installer", command: "bin/rbenv-installer", when: "ruby_rbenv_install_query.rc > 0", tags: [ruby] }
  - { name: "Ruby: Check local installation", shell: "{{ ansible_env.HOME }}/.rbenv/bin/rbenv versions --bare | grep '^{{ ruby_version }}$'", register: ruby_install_query, changed_when: no, failed_when: no, tags: [ruby] }
  - { name: "Ruby: Compile & install local package", command: "{{ ansible_env.HOME }}/.rbenv/bin/rbenv install '{{ ruby_version }}'", when: "ruby_install_query.rc > 0", tags: [ruby] }
  - { name: "Ruby: Set default version", command: "{{ ansible_env.HOME }}/.rbenv/bin/rbenv global '{{ ruby_version }}'", changed_when: no, tags: [ruby] }

  # 300. etkkeeper
  - { name: "etckeeper: Install packages", become: yes, apt: { pkg: [etckeeper], state: present } }
  - { name: "etckeeper: Turn off Git signing", become: yes, lineinfile: { path: "/etc/etckeeper/etckeeper.conf", regexp: "^GIT_COMMIT_OPTIONS=", line: "GIT_COMMIT_OPTIONS=\"--no-gpg-sign\"" } }

  # 400. Neovim
  - { name: "Neovim: Install AppImage", get_url: { url: "https://github.com/neovim/neovim/releases/download/v{{ neovim_version }}/nvim.appimage", dest: "/usr/local/bin/nvim-{{ neovim_version }}", mode: "+x", checksum: "{{ neovim_checksum }}" }, tags: [vim, neovim] }
  # 410. Neovim Python support
  - { name: "Neovim: Add Python support", become: yes, pip: { executable: "{{ item }}", name: pynvim, state: present }, with_items: [pip2, pip3], tags: [vim, neovim] }
  # 420. Neovim alternatives
  - { name: "Neovim: Set up alternatives", become: yes, alternatives: { name: "{{ item }}", link: "/usr/local/bin/{{ item }}", path: "/usr/local/bin/nvim-{{ neovim_version }}" }, with_items: [vi, vim, nvim, editor], tags: [vim, neovim] }

  # 500. Docker
  - { name: "Docker: Install prerequisites", become: yes, apt: { pkg: [apt-transport-https, ca-certificates, curl, gnupg-agent, software-properties-common], state: present }, tags: [docker] }
  - { name: "Docker: Import GPG key", become: yes, apt_key: { id: "{{ docker_gpg_key_id }}", url: "https://download.docker.com/linux/ubuntu/gpg" }, tags: [docker] }
  - { name: "Docker: Add repository", become: yes, apt_repository: { repo: "deb [arch={{ docker_platform }}] https://download.docker.com/linux/ubuntu {{ ansible_distribution_release }} stable", update_cache: yes }, tags: [docker] }
  - { name: "Docker: Install packages", become: yes, apt: { pkg: [docker-ce], state: present }, tags: [docker] }
  # 510. Docker Post-installation steps for Linux
  - { name: "Docker: Adding group", become: yes, group: { name: docker, state: present }, tags: [docker] }
  - { name: "Docker: Modifying user", become: yes, register: docker_user_groups, user: { name: "{{ ansible_user_id }}", append: yes, groups: [docker] }, tags: [docker] }
  - { debug: { msg: "Docker NOTE: You MUST log out and in again for changes to take effect." }, when: docker_user_groups.changed }
  # 520. Docker Compose
  - { name: "Docker: Install Docker Compose", get_url: { url: "https://github.com/docker/compose/releases/download/{{ docker_compose_version }}/docker-compose-{{ ansible_system }}-{{ ansible_machine }}", dest: "/usr/local/bin/docker-compose-{{ docker_compose_version }}", mode: "+x", checksum: "{{ docker_compose_checksum }}" }, tags: [docker] }
  # 525. Docker Machine
  - { name: "Docker: Install Docker Machine", get_url: { url: "https://github.com/docker/machine/releases/download/v{{ docker_machine_version }}/docker-machine-{{ ansible_system }}-{{ ansible_machine }}", dest: "/usr/local/bin/docker-machine-{{ docker_machine_version }}", mode: "+x", checksum: "{{ docker_machine_checksum }}" }, tags: [docker] }
  - name: "Docker: Install drivers for Docker Machine"
    get_url:
      url: "{{ item.value.url | format(name=item.key, version=item.value.version) }}"
      dest: "{% if '.zip' == item.value.url[-4:] %}/tmp/docker-machine-driver-{{ item.key }}-{{ item.value.version }}.zip{% else %}/usr/local/bin/docker-machine-driver-{{ item.key }}-{{ item.value.version }}{% endif %}"
      mode: "{% if '.zip' == item.value.url[-4:] %}{{ omit }}{%                                                             else %}+x{%                                                                           endif %}"
      checksum: "{{ item.value.checksum }}"
    with_dict: "{{ docker_machine_drivers }}"
    when: "not ( '/usr/local/bin/docker-machine-driver-' + item.key + '-' + item.value.version ) is is_file"
    tags: [docker]
  - { name: "Docker: Unpack drivers for Docker Machine", shell: "cd /tmp && unzip -o 'docker-machine-driver-{{ item.key }}-{{ item.value.version }}.zip' && mv './docker-machine-driver-{{ item.key }}' '/usr/local/bin/docker-machine-driver-{{ item.key }}-{{ item.value.version }}'", with_dict: "{{ docker_machine_drivers }}", when: "not ( '/usr/local/bin/docker-machine-driver-' + item.key + '-' + item.value.version ) is is_file and '.zip' == item.value.url[-4:]", tags: [docker] }
  # 530. Docker alternatives
  - { name: "Docker: Set up alternatives", become: yes, alternatives: { name: "{{ item.name }}", link: "/usr/local/bin/{{ item.name }}", path: "/usr/local/bin/{{ item.name }}-{{ item.version }}" }, tags: [docker], with_items: "{%
        set alternatives = [
          { 'name': 'docker-compose', 'version': docker_compose_version },
          { 'name': 'docker-machine', 'version': docker_machine_version }
        ]
      %}{%
        for key, driver in docker_machine_drivers | dictsort
      %}{%
          set _ = alternatives.extend([ { 'name': 'docker-machine-driver-' + key, 'version': driver.version } ])
      %}{%
        endfor
      %}{{ alternatives }}" }

  # 550. GnuPG
  - { name: "GnuPG: Install packages", become: yes, apt: { pkg: [gnupg, gnupg-agent, pinentry-curses, pinentry-gnome3], state: present } }
  - { name: "GnuPG: Create directories", file: "{{ item }}", with_items: [
      { path: "{{ ansible_env.HOME }}/.gnupg", state: directory }
    ] }
  - name: "GnuPG: Configure GPG"
    lineinfile:
      create: yes
      path: "{{ ansible_env.HOME }}/.gnupg/gpg.conf"
      regexp: "^[#\\s]*{{ item.key }}\\b"
      line: "{{ ( item.key | string + ' ' + item.value | default('') | string ) | trim }}"
      insertafter: 'EOF'
    with_dict: "{{ gnupg_conf }}"
  - name: "GnuPG: Configure GPG agent"
    lineinfile:
      create: yes
      path: "{{ ansible_env.HOME }}/.gnupg/gpg-agent.conf"
      regexp: "^[#\\s]*{{ item.key }}\\b"
      line: "{{ ( item.key | string + ' ' + item.value | default('') | string ) | trim }}"
      insertafter: 'EOF'
    with_dict: "{{ gnupg_agent_conf }}"

  # 590. i3wm
  - { name: "i3: Add APT key", become: yes, apt_key: { file: "{{ ansible_env.PWD }}/keys/sur5r-keyring.gpg", id: 'E3CA1A89941C42E6', state: present }, tags: [i3] }
  - { name: "i3: Add repository", become: yes, apt_repository: { repo: "deb https://debian.sur5r.net/i3/ {{ ansible_distribution_release }} universe", update_cache: yes }, tags: [i3] }
  - { name: "i3: Install packages", become: yes, apt: { pkg: [i3], state: present }, tags: [i3] }

  # 600. Firefox
  - { name: "Firefox: Install packages", become: yes, apt: { pkg: "{{ ('firefox firefox-locale-' + firefox_locales|join(' firefox-locale-')).split(' ') }}", state: present }, tags: [firefox] }
  - { name: "Firefox: Install extras", become: yes, apt: { pkg: [fonts-lyx], state: present }, tags: [firefox] }
  # 610. Firefox alternatives
  - { name: "Firefox: Set up alternatives", become: yes, alternatives: { name: "{{ item }}", path: "/usr/bin/firefox" }, with_items: [gnome-www-browser, x-www-browser], tags: [firefox] }
  # 620. Firefox policy for enterprise deployments
  - { name: "Firefox: Create enterprise deployment directories", become: yes, file: { path: "{{ item }}", state: directory, owner: "{{ ansible_user_id }}", mode: 0755 }, tags: [firefox], with_items: [
      "/usr/lib/firefox/distribution",
      "/usr/lib/mozilla/certificates",
      "/usr/local/lib/firefox",
      "/usr/local/lib/firefox/extensions"
    ] }
  - { name: "Firefox: Create directories", file: "{{ item }}", tags: [firefox], with_items: [
      { path: "{{ ansible_env.HOME }}/bin", state: directory },
      { path: "{{ ansible_env.HOME }}/.mozilla", state: directory },
      { path: "{{ ansible_env.HOME }}/.mozilla/native-messaging-hosts", state: directory }
    ] }
  - { name: "Firefox: Download unofficial extensions", get_url: { url: "{{ item.value.url | format(version=item.value.version, commit=item.value.commit | default(omit)) }}", dest: "/usr/local/lib/firefox/extensions/{{ item.key }}-{{ item.value.version + (\"-\" + item.value.commit if \"commit\" in item.value else \"\") }}-unofficial.xpi", checksum: "{{ item.value.checksum }}" }, with_dict: "{{ firefox_unofficial_extensions }}", tags: [firefox] }
  - name: "Firefox: Download native messaging hosts"
    get_url:
      url: "{{ item.value.native.url | format(version=item.value.version, commit=item.value.commit | default(omit)) }}"
      dest: "{{ item.value.native.path | regex_replace('^~', ansible_env.HOME) }}"
      checksum: "{{ item.value.native.checksum }}"
      mode: "{{ item.value.native.mode | default(omit) }}"
    with_dict: "{{ firefox_unofficial_extensions }}"
    when: "'native' in item.value"
    tags: [firefox]
  - name: "Firefox: Create native messaging hosts manifests"
    copy:
      dest: "{{ ansible_env.HOME }}/.mozilla/native-messaging-hosts/{{ item.value.native.name }}.json"
      content: "{{ {
        \"name\": item.value.native.name,
        \"description\": item.value.native.description | default(\"\"),
        \"path\": item.value.native.path | regex_replace(\"^~\", ansible_env.HOME),
        \"type\": item.value.native.type | default(\"stdio\"),
        \"allowed_extensions\": (item.value.native.allowed_extensions | default([]) | join(\",\") | format(version=item.value.version, commit=item.value.commit | default(omit))).split(\",\")
      } | to_nice_json }}"
      owner: "{{ ansible_user_id }}"
      mode: 0444
      force: yes
    with_dict: "{{ firefox_unofficial_extensions }}"
    when: "'native' in item.value"
    tags: [firefox]
  - { name: "Firefox: Create enterprise deployment policy", become: yes, copy: { dest: "/usr/lib/firefox/distribution/policies.json", content: "{{ firefox_policies | to_nice_json }}", owner: "{{ ansible_user_id }}", mode: 0444, force: yes }, tags: [firefox] }
  - name: "Firefox: Setting up AutoConfig"
    become: yes
    tags: [firefox]
    copy:
      dest: "/usr/lib/firefox/defaults/pref/autoconfig.js"
      owner: "{{ ansible_user_id }}"
      mode: 0444
      force: yes
      content: |
        // This file is managed by Ansible / Longitude.
        pref("general.config.filename", "firefox.cfg");
        pref("general.config.obscure_value", 0);
  - name: "Firefox: Create AutoConfig"
    become: yes
    tags: [firefox]
    copy:
      dest: "/usr/lib/firefox/firefox.cfg"
      owner: "{{ ansible_user_id }}"
      mode: 0444
      force: yes
      content: |
        // This file is managed by Ansible / Longitude. NOTE: preferences MUST start on line 2.
        {% for name, value in firefox_about_config | dictsort %}
        lockPref({{ name | to_json }}, {{ value | to_json }});
        {% endfor %}

  # 650. Waterfox
  - { name: "Waterfox: Check installation", become: yes, command: "ls /opt/waterfox-classic-{{ waterfox_version }}", register: waterfox_install_query, changed_when: no, failed_when: no, tags: [waterfox] }
  - { name: "Waterfox: Download classic build", get_url: { url: "https://storage-waterfox.netdna-ssl.com/releases/{{ waterfox_release }}/installer/waterfox-classic-{{ waterfox_version }}.{{ waterfox_locale }}.{{ waterfox_platform }}.tar.bz2", dest: "/tmp/waterfox-classic-{{ waterfox_version }}.tar.bz2", checksum: "{{ waterfox_checksum }}" }, when: "waterfox_install_query.rc > 0", tags: [waterfox] }
  - { name: "Waterfox: Unpack & install packages", when: "waterfox_install_query.rc > 0",
      shell: "cd /tmp && tar --overwrite -jxf 'waterfox-classic-{{ waterfox_version }}.tar.bz2' && mv waterfox-classic '/opt/waterfox-classic-{{ waterfox_version }}'", tags: [waterfox] }
  - { name: "Waterfox: Set up alternatives", become: yes, alternatives: { name: "{{ item }}", link: "/usr/local/bin/{{ item }}", path: "/opt/waterfox-classic-{{ waterfox_version }}/{{ item }}" }, tags: [waterfox], with_items: [
      waterfox,
    ] }
  - name: "Waterfox: Add desktop icon"
    become: yes
    copy:
      dest: "/usr/share/applications/waterfox.desktop"
      content: |
        [Desktop Entry]
        Version={{ waterfox_version }}
        Name=Waterfox Web Browser
        Comment=Browse the World Wide Web
        GenericName=Web Browser
        Keywords=Internet;WWW;Browser;Web;Explorer
        Exec=/opt/waterfox-classic-{{ waterfox_version }}/waterfox %u
        Terminal=false
        X-MultipleArgs=false
        Type=Application
        Icon=/opt/waterfox-classic-{{ waterfox_version }}/browser/chrome/icons/default/default256.png
        Categories=GNOME;GTK;Network;WebBrowser;
        MimeType=text/html;text/xml;application/xhtml+xml;application/xml;application/rss+xml;application/rdf+xml;image/gif;image/jpeg;image/png;x-scheme-handler/http;x-scheme-handler/https;x-scheme-handler/ftp;x-scheme-handler/chrome;video/webm;application/x-xpinstall;
        StartupNotify=true
        Actions=new-window;new-private-window;

        [Desktop Action new-window]
        Name=Open a New Window
        Exec=/opt/waterfox-classic-{{ waterfox_version }}/waterfox -new-window

        [Desktop Action new-private-window]
        Name=Open a New Private Window
        Exec=/opt/waterfox-classic-{{ waterfox_version }}/waterfox -private-window
    tags: [waterfox]

  # 660. Mailspring
  - { name: "Mailspring: Install prerequisites", become: yes, apt: { pkg: [xdg-utils, zenity], state: present }, tags: [mailspring] }
  - { name: "Mailspring: Check installation", become: yes, shell: "{{ dpkg_query | format('mailspring') }}", register: mailspring_dpkg_query, changed_when: no, failed_when: no, tags: [mailspring] }
  - { name: "Mailspring: Download packages", get_url: { url: "https://github.com/Foundry376/Mailspring/releases/download/{{ mailspring_version }}/mailspring-{{ mailspring_version }}-{{ mailspring_platform }}.deb", dest: "/tmp/mailspring-{{ mailspring_version }}.deb", checksum: "{{ mailspring_checksum }}" }, when: "mailspring_dpkg_query.rc > 0", tags: [mailspring] }
  - { name: "Mailspring: Install packages", become: yes, apt: { deb: "/tmp/mailspring-{{ mailspring_version }}.deb", state: present }, when: "mailspring_dpkg_query.rc > 0", tags: [mailspring] }
  - { name: "Mailspring: Check MIME handler", command: 'xdg-mime query default x-scheme-handler/mailto', register: mailspring_mime_query_1, changed_when: no, failed_when: no, tags: [mailspring] }
  - { name: "Mailspring: Set as MIME handler", when: "(mailspring_mime_query_1.rc == 0) and ('mailspring.desktop' not in mailspring_mime_query_1.stdout)", command: "xdg-mime default mailspring.desktop x-scheme-handler/mailto", tags: [mailspring] }

  # 700. Dropbox
  - { name: "Dropbox: Install prerequisites", become: yes, apt: { pkg: [python-gpgme, python3-gpgme], state: present }, when: "ansible_distribution_version is version('17.10', '<')" }
  - { name: "Dropbox: Install prerequisites", become: yes, apt: { pkg: [python-gpg, python3-gpg], state: present }, when: "ansible_distribution_version is version('17.10', '>=')" }
  - { name: "Dropbox: Check installation", become: yes, shell: "{{ dpkg_query | format('dropbox') }}", register: dropbox_dpkg_query, changed_when: no, failed_when: no }
    # NOTE: I don't know of a way to verify the .deb Dropbox package, is there an alternative way to install, perhaps via an APT repository?
  - { name: "Dropbox: Install packages", become: yes, when: "dropbox_dpkg_query.rc > 0", apt: { deb: "https://www.dropbox.com/download?dl=packages/ubuntu/dropbox_{{ dropbox_version }}_{{ dropbox_platform }}.deb", state: present } }

  # 750. Keybase
  - { name: "Keybase: Install prerequisites", become: yes, apt: { pkg: [gnupg, curl], state: present }, tags: [keybase] }
  - { name: "Keybase: Check installation", become: yes, shell: "{{ dpkg_query | format('keybase') }}", register: keybase_dpkg_query, changed_when: no, failed_when: no, tags: [keybase] }
  - { name: "Keybase: Download package and signature", get_url: { url: "{{ item }}", dest: "/tmp/{{ item | basename }}" }, when: "keybase_dpkg_query.rc > 0", tags: [keybase], with_items: [
      "https://prerelease.keybase.io/keybase_{{ keybase_platform }}.deb",
      "https://prerelease.keybase.io/keybase_{{ keybase_platform }}.deb.sig"
    ] }
  - { name: "Keybase: Check package signature", command: "gpg --status-fd 1 --no-default-keyring --keyring '{{ ansible_env.PWD }}/keys/keybase-20190624.asc.gpg' --verify /tmp/keybase_{{ keybase_platform }}.deb.sig", when: "keybase_dpkg_query.rc > 0", tags: [keybase] }
  - { name: "Keybase: Install package", become: yes, apt: { deb: "/tmp/keybase_{{ keybase_platform }}.deb", state: present }, when: "keybase_dpkg_query.rc > 0", tags: [keybase] }

  # 760. Tarsnap
  - { name: "Tarsnap: Install prerequisites", become: yes, apt: { pkg: [gcc, libc6-dev, make, libssl-dev, zlib1g-dev, e2fslibs-dev], state: present }, tags: [tarsnap] }
  - { name: "Tarsnap: Check installation", become: yes, command: "ls /opt/tarsnap-{{ tarsnap_version }}", register: tarsnap_install_query, changed_when: no, failed_when: no, tags: [tarsnap] }
  - { name: "Tarsnap: Download package and signature", get_url: { url: "{{ item }}", dest: "/tmp/{{ item | basename }}" }, when: "tarsnap_install_query.rc > 0", tags: [tarsnap], with_items: [
      "https://www.tarsnap.com/download/tarsnap-autoconf-{{ tarsnap_version }}.tgz",
      "https://www.tarsnap.com/download/tarsnap-sigs-{{ tarsnap_version }}.asc"
    ] }
  - { name: "Tarsnap: Check package signature", command: "gpg --status-fd 1 --no-default-keyring --keyring '{{ ansible_env.PWD }}/keys/tarsnap-signing-key-2020.asc.gpg' --verify /tmp/tarsnap-sigs-{{ tarsnap_version }}.asc", when: "tarsnap_install_query.rc > 0", tags: [tarsnap] }
  - name: "Tarsnap: Compile & install packages"
    when: "tarsnap_install_query.rc > 0"
    shell: |
      cd /tmp &&
      tar --overwrite -zxf 'tarsnap-autoconf-{{ tarsnap_version }}.tgz' &&
      cd 'tarsnap-autoconf-{{ tarsnap_version }}' &&
      ./configure --prefix='/opt/tarsnap-{{ tarsnap_version }}' &&
      make all && make install
    args: { executable: "/bin/bash" }
    tags: [tarsnap]
  - { name: "Tarsnap: Set up alternatives", become: yes, alternatives: { name: "{{ item }}", link: "/usr/local/bin/{{ item }}", path: "/opt/tarsnap-{{ tarsnap_version }}/bin/{{ item }}" }, tags: [tarsnap], with_items: [
      tarsnap,
      tarsnap-keygen,
      tarsnap-keymgmt,
      tarsnap-keyregen,
      tarsnap-recrypt
    ] }

  # 900. Tools and miscellaneous
  #
  - { name: "Miscellaneous: Install packages", become: yes, apt: { pkg: "{{ lookup('file', 'apt.present.txt').splitlines() | map('regex_replace', '#.*$', '') | map('trim') | select('regex', '.') | list }}", state: present } }
  - { name: "Miscellaneous: Add Python support for dconf", become: yes, pip: { executable: pip2, name: psutil, state: present } }
  - { name: "Miscellaneous: Configure the system", dconf: "{{ item }}", when: "ansible_env.IS_DOCKERIZED | default(0) != '1'", with_items: [
      { key: "/org/gnome/mutter/overlay-key", value: "''" },
      { key: "/org/gnome/desktop/input-sources/xkb-options", value: "['compose:ralt']" }
    ] }
  - { name: "Miscellaneous: Create directories", file: "{{ item }}", with_items: [
      { path: "{{ ansible_env.HOME }}/.config/fontconfig", state: directory },
      { path: "{{ ansible_env.HOME }}/.config/fontconfig/conf.d", state: directory }
    ] }
  - name: "Miscellaneous: Configure fonts"
    copy:
      dest: "{{ ansible_env.HOME }}/.config/fontconfig/conf.d/10-calibri.conf"
      force: no
      content: |
        <?xml version="1.0"?>
        <!DOCTYPE fontconfig SYSTEM "fonts.dtd">
        <fontconfig>
            <match target="font">
                <test name="family" compare="contains">
                    <string>Calibri</string>
                </test>
                <edit name="embeddedbitmap">
                    <bool>false</bool>
                </edit>
            </match>
        </fontconfig>

  # 910. ImageMagick
  - { name: "ImageMagick: Install prerequisites", become: yes, apt: { pkg: [graphviz-dev, libpng-dev, libjpeg-dev, libgs-dev], state: present } }
  - { name: "ImageMagick: Check installation", become: yes, command: "ls /opt/ImageMagick-{{ imagemagick_version }}", register: imagemagick_install_query, changed_when: no, failed_when: no }
  - { name: "ImageMagick: Download source", get_url: { url: "http://download.ubk.hu/src/imagemagick/ImageMagick-{{ imagemagick_version }}.tar.xz", dest: "/tmp/ImageMagick-{{ imagemagick_version }}.tar.xz", checksum: "{{ imagemagick_checksum }}" }, when: "imagemagick_install_query.rc > 0" }
  - { name: "ImageMagick: Compile & install packages", when: "imagemagick_install_query.rc > 0",
      shell: "cd /tmp && tar --overwrite -Jxf 'ImageMagick-{{ imagemagick_version }}.tar.xz' && cd 'ImageMagick-{{ imagemagick_version }}' && ./configure --prefix='/opt/ImageMagick-{{ imagemagick_version }}' && make -j8 && make install" }
  - { name: "ImageMagick: Set up alternatives", become: yes, alternatives: { name: "{{ item }}", link: "/usr/local/bin/{{ item }}", path: "/opt/ImageMagick-{{ imagemagick_version }}/bin/{{ item }}" }, with_items: [
      animate,
      compare,
      composite,
      conjure,
      convert,
      display,
      identify,
      import,
      magick,
      magick-script,
      mogrify,
      montage,
      stream,

      Magick++-config,
      MagickCore-config,
      MagickWand-config
    ] }
  - { name: "ImageMagick: Check system installation", become: yes, command: "apt-mark showhold", register: imagemagick_system_install_query, changed_when: no, failed_when: no }
  - { name: "ImageMagick: Hold system packages", become: yes, when: "'imagemagick' not in imagemagick_system_install_query.stdout", command: "apt-mark hold imagemagick" }
  - { name: "ImageMagick: Allow manipulation of PDF files", lineinfile: { path: "/opt/ImageMagick-{{ imagemagick_version }}/etc/ImageMagick-{{ imagemagick_version.split('.')[0] }}/policy.xml", regexp: "PDF", line: '  <policy domain="module" rights="read|write" pattern="{PS,PDF,XPS}" />' } }

  # 920. youtube-dl
  - { name: "youtube-dl: Install script", get_url: { url: "https://github.com/ytdl-org/youtube-dl/releases/download/{{ youtube_dl_version }}/youtube-dl", dest: "/usr/local/bin/youtube-dl", mode: "+x", checksum: "{{ youtube_dl_checksum }}" } }

  # 940. fd
  - { name: "fd: Check installation", become: yes, shell: "{{ dpkg_query | format('fd') }}", register: fd_dpkg_query, changed_when: no, failed_when: no, tags: [fd] }
  - { name: "fd: Download packages", get_url: { url: "https://github.com/sharkdp/fd/releases/download/v{{ fd_version }}/fd_{{ fd_version }}_{{ fd_platform }}.deb", dest: "/tmp/fd-{{ fd_version }}.deb", checksum: "{{ fd_checksum }}" }, when: "fd_dpkg_query.rc > 0", tags: [fd] }
  - { name: "fd: Install packages", become: yes, apt: { deb: "/tmp/fd-{{ fd_version }}.deb", state: present }, when: "fd_dpkg_query.rc > 0", tags: [fd] }
  # 950. ripgrep
  - { name: "ripgrep: Check installation", become: yes, shell: "{{ dpkg_query | format('ripgrep') }}", register: ripgrep_dpkg_query, changed_when: no, failed_when: no, tags: [ripgrep] }
  - { name: "ripgrep: Download packages", get_url: { url: "https://github.com/BurntSushi/ripgrep/releases/download/{{ ripgrep_version }}/ripgrep_{{ ripgrep_version }}_{{ ripgrep_platform }}.deb", dest: "/tmp/ripgrep-{{ ripgrep_version }}.deb", checksum: "{{ ripgrep_checksum }}" }, when: "ripgrep_dpkg_query.rc > 0", tags: [ripgrep] }
  - { name: "ripgrep: Install packages", become: yes, apt: { deb: "/tmp/ripgrep-{{ ripgrep_version }}.deb", state: present }, when: "ripgrep_dpkg_query.rc > 0", tags: [ripgrep] }
  # 955. fzf
  - { name: "fzf: Check installation", become: yes, command: "ls /usr/local/bin/fzf-{{ fzf_version }}", register: fzf_install_query, changed_when: no, failed_when: no }
  - { name: "fzf: Download fzf", get_url: { url: "https://github.com/junegunn/fzf-bin/releases/download/{{ fzf_version }}/fzf-{{ fzf_version }}-{{ fzf_platform }}.tgz", dest: "/tmp/fzf-{{ fzf_version }}.tgz", checksum: "{{ fzf_checksum }}" }, when: "fzf_install_query.rc > 0" }
  - { name: "fzf: Install fzf", shell: "cd /tmp && tar --overwrite -zxf 'fzf-{{ fzf_version }}.tgz' && mv ./fzf '/usr/local/bin/fzf-{{ fzf_version }}'", when: "fzf_install_query.rc > 0" }
  - { name: "fzf: Set up alternatives", become: yes, alternatives: { name: "fzf", link: "/usr/local/bin/fzf", path: "/usr/local/bin/fzf-{{ fzf_version }}" } }
  - { name: "fzf: Create empty Zsh configuration", copy: { content: "", dest: "{{ ansible_env.HOME }}/.fzf.zsh", force: no } }
  # 960. pup
  - { name: "pup: Check installation", become: yes, command: "ls /usr/local/bin/pup-{{ pup_version }}", register: pup_install_query, changed_when: no, failed_when: no }
  - { name: "pup: Download pup", get_url: { url: "https://github.com/EricChiang/pup/releases/download/v{{ pup_version }}/pup_v{{ pup_version }}_{{ pup_platform }}.zip", dest: "/tmp/pup-{{ pup_version }}.zip", checksum: "{{ pup_checksum }}" }, when: "pup_install_query.rc > 0" }
  - { name: "pup: Install pup", shell: "cd /tmp && unzip -o 'pup-{{ pup_version }}.zip' && mv ./pup '/usr/local/bin/pup-{{ pup_version }}'", when: "pup_install_query.rc > 0" }
  - { name: "pup: Set up alternatives", become: yes, alternatives: { name: "pup", link: "/usr/local/bin/pup", path: "/usr/local/bin/pup-{{ pup_version }}" } }
  # 965. jq
  - { name: "jq: Check installation", become: yes, command: "ls /usr/local/bin/jq-{{ jq_version }}", register: jq_install_query, changed_when: no, failed_when: no }
  - { name: "jq: Download jq", get_url: { url: "https://github.com/stedolan/jq/releases/download/jq-{{ jq_version }}/jq-{{ jq_platform }}", dest: "/usr/local/bin/jq-{{ jq_version }}", mode: "+x", checksum: "{{ jq_checksum }}" }, when: "jq_install_query.rc > 0" }
  - { name: "jq: Set up alternatives", become: yes, alternatives: { name: "jq", link: "/usr/local/bin/jq", path: "/usr/local/bin/jq-{{ jq_version }}" } }
  # 970. HTTPie
  - { name: "HTTPie: Install packages", pip: { executable: "pip{{ python_version.split('.')[:2]|join('.') }}", extra_args: '--user', name: httpie, version: "{{ httpie_version }}", state: present }, tags: [httpie] }
  - { name: "HTTPie: Install plug-ins", pip: { executable: "pip{{ python_version.split('.')[:2]|join('.') }}", extra_args: '--user', name: "{{ item.name }}", version: "{{ item.version }}", state: present }, tags: [httpie], with_items: "{{ httpie_plugins }}" }
  # 980. bat
  - { name: "bat: Check installation", become: yes, shell: "{{ dpkg_query | format('bat-musl') }}", register: bat_dpkg_query, changed_when: no, failed_when: no }
  - { name: "bat: Download packages", get_url: { url: "https://github.com/sharkdp/bat/releases/download/v{{ bat_version }}/bat-musl_{{ bat_version }}_{{ bat_platform }}.deb", dest: "/tmp/bat-{{ bat_version }}.deb", checksum: "{{ bat_checksum }}" }, when: "bat_dpkg_query.rc > 0" }
  - { name: "bat: Install packages", become: yes, apt: { deb: "/tmp/bat-{{ bat_version }}.deb", state: present }, when: "bat_dpkg_query.rc > 0" }
  # 985. xidel
  - { name: "Xidel: Check installation", become: yes, shell: "{{ dpkg_query | format('xidel') }}", register: xidel_dpkg_query, changed_when: no, failed_when: no }
  - { name: "Xidel: Download packages", get_url: { url: "https://sourceforge.net/projects/videlibri/files/Xidel/Xidel%20{{ xidel_version.split('-')[0] }}/xidel_{{ xidel_version }}_{{ xidel_platform }}.deb/download", dest: "/tmp/xidel-{{ xidel_version }}.deb", checksum: "{{ xidel_checksum }}" }, when: "xidel_dpkg_query.rc > 0" }
  - { name: "Xidel: Install packages", become: yes, apt: { deb: "/tmp/xidel-{{ xidel_version }}.deb", state: present }, when: "xidel_dpkg_query.rc > 0" }
  # 990. ngrok
  - { name: "ngrok: Check installation", become: yes, command: "ls /usr/local/bin/ngrok", register: ngrok_install_query, changed_when: no, failed_when: no }
  - { name: "ngrok: Download ngrok", get_url: { url: "https://bin.equinox.io/a/{{ ngrok_stable_channel_id }}/ngrok-{{ ngrok_version }}-{{ ngrok_platform }}.zip", dest: "/tmp/ngrok.zip", checksum: "{{ ngrok_checksum }}" }, when: "ngrok_install_query.rc > 0" }
  - { name: "ngrok: Install ngrok", shell: "cd /tmp && unzip -o ngrok.zip && mv ./ngrok /usr/local/bin/ngrok", when: "ngrok_install_query.rc > 0" }
  # 995. ffsend (Firefox Send CLI)
  - { name: "Install ffsend", get_url: { url: "https://github.com/timvisee/ffsend/releases/download/v{{ ffsend_version }}/ffsend-v{{ ffsend_version }}-{{ ffsend_platform }}-static", dest: "/usr/local/bin/ffsend", mode: "+x", checksum: "{{ ffsend_checksum }}" } }
  # 996. Magic Wormhole
  - { name: "Magic Wormhole: Install prerequisites", become: yes, apt: { pkg: [libffi-dev], state: present }, tags: [wormhole] }
  - { name: "Magic Wormhole: Install package", pip: { executable: "pip{{ python_version.split('.')[:2]|join('.') }}", extra_args: '--user', name: magic-wormhole, state: present }, tags: [wormhole] }
  # 997. Terraform & plug-ins
  - { name: "Terraform: Check installation", become: yes, command: "ls '/opt/terraform-{{ terraform_version }}/bin/terraform'", register: terraform_install_query, changed_when: no, failed_when: no, tags: [terraform] }
  - { name: "Terraform: Download package", get_url: { url: "https://releases.hashicorp.com/terraform/{{ terraform_version }}/terraform_{{ terraform_version }}_{{ terraform_platform }}.zip", dest: "/tmp/terraform.zip", checksum: "{{ terraform_checksum }}" }, when: "terraform_install_query.rc > 0", tags: [terraform] }
  - { name: "Terraform: Install package", shell: "cd /tmp && unzip -o terraform.zip && mkdir -p '/opt/terraform-{{ terraform_version }}/bin' && mv ./terraform '/opt/terraform-{{ terraform_version }}/bin/terraform'", when: "terraform_install_query.rc > 0", tags: [terraform] }
  - { name: "Terraform: Set up alternatives", become: yes, alternatives: { name: "terraform", link: "/usr/local/bin/terraform", path: "/opt/terraform-{{ terraform_version }}/bin/terraform" }, tags: [terraform] }
  - { name: "Terraform: Set up plug-ins directories", file: { path: "{{ item }}", state: directory }, tags: [terraform], with_items: [
      "{{ ansible_env.HOME }}/.terraform.d",
      "{{ ansible_env.HOME }}/.terraform.d/plugins",
    ] }
  - name: "Terraform: Download plug-ins"
    get_url:
      url: "{{ item.value.url | format(name=item.key, version=item.value.version, platform=terraform_platform) }}"
      dest: "{{ ansible_env.HOME }}/.terraform.d/plugins/{{ item.key }}_v{{ item.value.version }}"
      mode: '+x'
      checksum: "{{ item.value.checksum }}"
    with_dict: "{{ terraform_plugins }}"
    tags: [terraform]

  # 999. AWS CLI
  - { name: "AWS: Install CLI packages", pip: { executable: "pip{{ python_version.split('.')[:2]|join('.') }}", extra_args: '--user', name: awscli, version: "{{ awscli_version }}", state: present }, tags: [aws, awscli] }

  # 1000. Dotfiles
  - { name: "Dotfiles: Clone the repository", git: { repo: "https://github.com/StanAngeloff/dotfiles.git", dest: "{{ ansible_env.HOME }}/dotfiles", remote: "github", update: no } }
  # 1010. Dotfiles linking files
  - { name: "Dotfiles: Creating directories and linking files", file: "{{ item }}", with_items: [
      { path: "{{ ansible_env.HOME }}/.vim", src: "./dotfiles/.vim", state: link, force: yes },
      { path: "{{ ansible_env.HOME }}/.config/nvim", src: "../.vim", state: link, force: yes },
      { path: "{{ ansible_env.HOME }}/.urxvt", src: "./dotfiles/.urxvt", state: link, force: yes },
      { path: "{{ ansible_env.HOME }}/.zsh", src: "./dotfiles/.zsh", state: link, force: yes },

      { path: "{{ ansible_env.HOME }}/.vim/autoload", state: directory },

      { path: "{{ ansible_env.HOME }}/.local", state: directory },
      { path: "{{ ansible_env.HOME }}/.local/share", state: directory },
      { path: "{{ ansible_env.HOME }}/.local/share/applications", state: directory },
      { path: "{{ ansible_env.HOME }}/.local/share/icons", state: directory },

      { path: "{{ ansible_env.HOME }}/.vimrc", src: "{{ ansible_env.HOME }}/dotfiles/.vimrc", state: hard, force: yes },
      { path: "{{ ansible_env.HOME }}/.config/nvim/init.vim", src: "{{ ansible_env.HOME }}/.vimrc", state: hard, force: yes },
      { path: "{{ ansible_env.HOME }}/.gitconfig", src: "{{ ansible_env.HOME }}/dotfiles/.gitconfig", state: hard, force: yes }, # NOTE: See https://stackoverflow.com/q/11786623
      { path: "{{ ansible_env.HOME }}/.rgrc", src: "{{ ansible_env.HOME }}/dotfiles/.rgrc", state: hard, force: yes },
      { path: "{{ ansible_env.HOME }}/.tigrc", src: "{{ ansible_env.HOME }}/dotfiles/.tigrc", state: hard, force: yes },
      { path: "{{ ansible_env.HOME }}/.tigrc.vim", src: "{{ ansible_env.HOME }}/dotfiles/.tigrc.vim", state: hard, force: yes },
      { path: "{{ ansible_env.HOME }}/.tmux.conf", src: "{{ ansible_env.HOME }}/dotfiles/.tmux.conf", state: hard, force: yes },
      { path: "{{ ansible_env.HOME }}/.zshrc", src: "{{ ansible_env.HOME }}/dotfiles/.zshrc", state: hard, force: yes },
      { path: "{{ ansible_env.HOME }}/.Xresources", src: "{{ ansible_env.HOME }}/dotfiles/.Xresources", state: hard, force: yes }
    ] }
  # 1020. Dotfiles install Vim plug-ins
  - { name: "Dotfiles: Install vim-plug", get_url: { url: "https://raw.githubusercontent.com/junegunn/vim-plug/master/plug.vim", dest: "{{ ansible_env.HOME }}/.vim/autoload/plug.vim" }, register: vim_plug_installed }
  - { name: "Dotfiles: Disable Git fsckObjects", command: "git config --global fetch.fsckObjects false", changed_when: no }
  - { name: "Dotfiles: Download Vim dictionaries", get_url: { url: "http://ftp.vim.org/vim/runtime/spell/{{ item[0] }}.{{ item[1] }}", dest: "{{ ansible_env.HOME }}/.config/nvim/spell/{{ item[0] }}.{{ item[1] }}" }, with_nested: [
      ["{{ neovim_dictionaries }}"],
      [spl, sug]
    ] }
  - { name: "Dotfiles: Install Vim plug-ins", command: "nvim -Es -u {{ ansible_env.HOME }}/.config/nvim/init.vim +PlugInstall +qa", when: vim_plug_installed.changed, failed_when: no }
  - { name: "Dotfiles: Re-enable Git fsckObjects", command: "git config --global fetch.fsckObjects true", changed_when: no }

  # 1100. Zsh
  - { name: "Zsh: Install prerequisites", become: yes, apt: { pkg: [libncurses-dev], state: present }, tags: [zsh] }
  - { name: "Zsh: Check installation", become: yes, command: "ls /opt/zsh-{{ zsh_version }}", register: zsh_install_query, changed_when: no, failed_when: no, tags: [zsh] }
  - { name: "Zsh: Download source", get_url: { url: "https://sourceforge.net/projects/zsh/files/zsh/{{ zsh_version }}/zsh-{{ zsh_version }}.tar.xz/download", dest: "/tmp/zsh-{{ zsh_version }}.tar.xz", checksum: "{{ zsh_checksum }}" }, when: "zsh_install_query.rc > 0", tags: [zsh] }
  - { name: "Zsh: Compile & install packages", when: "zsh_install_query.rc > 0",
      shell: "cd /tmp && tar --overwrite -Jxf 'zsh-{{ zsh_version }}.tar.xz' && cd 'zsh-{{ zsh_version }}' && ./configure --enable-pcre --prefix='/opt/zsh-{{ zsh_version }}' {% if ansible_env.IS_DOCKERIZED | default(0) == '1' %} --without-tcsetpgrp {% endif %} && make -j8 && make install", tags: [zsh] }
  - { name: "Zsh: Set up alternatives", become: yes, alternatives: { name: "zsh", link: "/bin/zsh", path: "/opt/zsh-{{ zsh_version }}/bin/zsh" }, tags: [zsh] }
  - { name: "Zsh: Add to /etc/shells", become: yes, lineinfile: { path: "/etc/shells", line: "/bin/zsh" }, tags: [zsh] }
  - { name: "Zsh: Check shell", become: yes, shell: "cat /etc/passwd | grep '^{{ ansible_user_id }}:' | cut -d: -f7", register: zsh_shell_query, changed_when: no, tags: [zsh] }
  - { name: "Zsh: Change shell", become: yes, command: "chsh -s /bin/zsh '{{ ansible_user_id }}'", when: "zsh_shell_query.stdout != '/bin/zsh'", tags: [zsh] }

  - { name: "Reset connection to allow shell changes", meta: reset_connection }

  # 1200. rxvt-unicode
  - { name: "rxvt-unicode: Install prerequisites", become: yes, apt: { pkg: [cvs, libperl-dev, libx11-dev, libxft-dev, xdotool, xsel], state: present }, tags: [rxvt, urxvt] }
  - { name: "rxvt-unicode: Check installation", become: yes, command: "ls /opt/rxvt-unicode-{{ rxvt_unicode_version }}", register: rxvt_unicode_install_query, changed_when: no, failed_when: no, tags: [rxvt, urxvt] }
  - { name: "rxvt-unicode: Download CVS source", command: "cvs -q -z3 -d :pserver:anonymous@cvs.schmorp.de/schmorpforge checkout -D \"{{ rxvt_unicode_cvs_date }}\" rxvt-unicode", args: { chdir: '/tmp' }, when: "rxvt_unicode_install_query.rc > 0", tags: [rxvt, urxvt] }
  - { name: "rxvt-unicode: Download patches", get_url: { url: "{{ item.1.url }}", dest: "/tmp/rxvt-unicode-{{ item.0 }}.patch", checksum: "{{ item.1.checksum }}" }, with_indexed_items: "{{ rxvt_unicode_patches }}", when: "rxvt_unicode_install_query.rc > 0", tags: [rxvt, urxvt] }
  - name: "rxvt-unicode: Patch, compile & install packages"
    when: "rxvt_unicode_install_query.rc > 0"
    shell: |
      cd /tmp/rxvt-unicode &&
      {% for patch in rxvt_unicode_patches %}
        echo "Patching {{ patch.url | basename }}"  &&
        patch --quiet --forward -p{{ patch.strip | default(0) }} < "/tmp/rxvt-unicode-{{ loop.index0 }}.patch" &&
      {% endfor %}
      ./configure {{ rxvt_unicode_configure_args | join(" ") }} --prefix="/opt/rxvt-unicode-{{ rxvt_unicode_version }}" &&
      make -j8 &&
      make install
    args: { executable: "/bin/bash" }
    tags: [rxvt, urxvt]
  - { name: "rxvt-unicode: Set up alternatives", become: yes, alternatives: { name: "{{ item }}", link: "/usr/local/bin/{{ item }}", path: "/opt/rxvt-unicode-{{ rxvt_unicode_version }}/bin/{{ item }}" }, tags: [rxvt, urxvt], with_items: [
      urxvt,
      urxvtc,
      urxvtd
    ] }
  - { name: "rxvt-unicode: Create desktop entry", copy: { content: "[Desktop Entry]\nVersion=1.0\nName=urxvt\nComment=An unicode capable rxvt clone\nExec=urxvt\nIcon=utilities-terminal\nTerminal=false\nType=Application\nCategories=System;TerminalEmulator;", dest: "{{ ansible_env.HOME }}/.local/share/applications/urxvt.desktop", force: no }, tags: [rxvt, urxvt] }
  - { name: "rxvt-unicode: Create launch script", copy: { content: "#!/bin/sh\n\nxdotool search --class urxvt windowactivate || urxvt -e /bin/zsh -c 'tmux attach-session -t default 2>/dev/null || tmux new-session -s default -n default'", dest: "/usr/local/bin/urxvt-start", force: no, mode: "+x" }, tags: [rxvt, urxvt] }
  - { name: "rxvt-unicode: Set up as default terminal", become: yes, alternatives: { name: "x-terminal-emulator", path: "/usr/local/bin/urxvt-start" }, tags: [rxvt, urxvt] }

  # 1300. tmux
  - { name: "tmux: Install prerequisites", become: yes, apt: { pkg: [libevent-dev], state: present }, tags: [tmux] }
  - { name: "tmux: Check installation", become: yes, command: "ls /opt/tmux-{{ tmux_version }}", register: tmux_install_query, changed_when: no, failed_when: no, tags: [tmux] }
  - { name: "tmux: Download source", get_url: { url: "https://github.com/tmux/tmux/releases/download/{{ tmux_version }}/tmux-{{ tmux_version }}.tar.gz", dest: "/tmp/tmux-{{ tmux_version }}.tar.gz", checksum: "{{ tmux_checksum }}" }, when: "tmux_install_query.rc > 0", tags: [tmux] }
  - { name: "tmux: Compile & install packages", when: "tmux_install_query.rc > 0", tags: [tmux],
      shell: "cd /tmp && tar --overwrite -zxf 'tmux-{{ tmux_version }}.tar.gz' && cd 'tmux-{{ tmux_version }}' && ./configure --prefix='/opt/tmux-{{ tmux_version }}' && make -j8 && make install" }
  - { name: "tmux: Set up alternatives", become: yes, alternatives: { name: "tmux", link: "/usr/local/bin/tmux", path: "/opt/tmux-{{ tmux_version }}/bin/tmux" }, tags: [tmux] }
  - { name: "tmux: Set up plug-ins directories", file: { path: "{{ item }}", state: directory }, tags: [tmux], with_items: [
      "{{ ansible_env.HOME }}/.tmux",
      "{{ ansible_env.HOME }}/.tmux/plugins",
    ] }
  - { name: "tmux: Clone Tmux Plugin Manager", git: { repo: "https://github.com/tmux-plugins/tpm", dest: "{{ ansible_env.HOME }}/.tmux/plugins/tpm", remote: "github", update: no }, tags: [tmux] }

  # 1400. tig
  - { name: "tig: Install prerequisites", become: yes, apt: { pkg: [libncursesw5-dev], state: present }, tags: [tig] }
  - { name: "tig: Check installation", become: yes, command: "ls /opt/tig-{{ tig_version }}", register: tig_install_query, changed_when: no, failed_when: no, tags: [tig] }
  - { name: "tig: Download source", get_url: { url: "https://github.com/jonas/tig/releases/download/tig-{{ tig_version }}/tig-{{ tig_version }}.tar.gz", dest: "/tmp/tig-{{ tig_version }}.tar.gz", checksum: "{{ tig_checksum }}" }, when: "tig_install_query.rc > 0", tags: [tig] }
  - name: "tig: Compile & install packages"
    when: "tig_install_query.rc > 0"
    shell: |
      cd /tmp &&
      tar --overwrite -zxf 'tig-{{ tig_version }}.tar.gz' &&
      cd 'tig-{{ tig_version }}' &&
      ./configure --prefix='/opt/tig-{{ tig_version }}' &&
      make -j8 && make install
    tags: [tig]
  - { name: "tig: Set up alternatives", become: yes, alternatives: { name: "tig", link: "/usr/local/bin/tig", path: "/opt/tig-{{ tig_version }}/bin/tig" }, tags: [tig] }

  # 1450. envchain
  - { name: "envchain: Install prerequisites", become: yes, apt: { pkg: [libsecret-1-dev, libreadline-dev], state: present } }
  - { name: "envchain: Check installation", become: yes, command: "ls /usr/local/bin/envchain", register: envchain_install_query, changed_when: no, failed_when: no }
  - { name: "envchain: Download source", get_url: { url: "https://github.com/sorah/envchain/archive/v{{ envchain_version }}.tar.gz", dest: "/tmp/envchain-{{ envchain_version }}.tar.gz", checksum: "{{ envchain_checksum }}" }, when: "envchain_install_query.rc > 0" }
  - { name: "envchain: Compile & install packages", when: "envchain_install_query.rc > 0",
      shell: "cd /tmp && tar --overwrite -zxf 'envchain-{{ envchain_version }}.tar.gz' && cd 'envchain-{{ envchain_version }}' && make && make install DESTDIR='/usr/local'" }

  # 1500. PHP & extensions
  - { name: "PHP: Add PPA", become: yes, apt_repository: { repo: "ppa:ondrej/php", update_cache: yes }, tags: [php] }
  - { name: "PHP: Install packages", become: yes, apt: { pkg: "{{ ('php-pear php' + php_version|string + '-cli php' + php_version|string + '-dev php' + php_version|string + '-' + php_extensions|join(' php' + php_version|string + '-')).split(' ') }}", state: present }, tags: [php] }
  - { name: "PHP: Check Composer installation", become: yes, command: "ls /usr/local/bin/composer", register: composer_install_query, changed_when: no, failed_when: no, tags: [php, composer] }
  - { name: "PHP: Download Composer setup", get_url: { url: "https://getcomposer.org/installer", dest: "/tmp/composer-setup.php", checksum: "sha384:{{ lookup('url', 'https://composer.github.io/installer.sig', split_lines=false) }}" }, when: "composer_install_query.rc > 0", tags: [php, composer] }
  - { name: "PHP: Install Composer", command: "{{ item }}", when: "composer_install_query.rc > 0", tags: [php, composer], with_items: [
      "php /tmp/composer-setup.php --install-dir=/usr/local/bin --filename=composer",
      "php -r \"unlink('/tmp/composer-setup.php');\"",
    ] }

  # 1600. NodeJS
  - { name: "NodeJS: Import GPG key", become: yes, apt_key: { id: "{{ nodesource_gpg_key_id }}", url: "https://deb.nodesource.com/gpgkey/nodesource.gpg.key" } }
  - { name: "NodeJS: Add repository", become: yes, apt_repository: { repo: "deb https://deb.nodesource.com/node_{{ nodejs_version }}.x {{ ansible_distribution_release }} main", update_cache: yes } }
  - { name: "NodeJS: Install packages", become: yes, apt: { pkg: [nodejs], state: present } }
  - { name: "NodeJS: Create directories", become: yes, file: { path: "/usr/local/lib/node_modules", state: directory, owner: "{{ ansible_user_id }}" } }
  - { name: "NodeJS: Install global packages in /usr/local", lineinfile: { create: yes, path: "{{ ansible_env.HOME }}/.npmrc", regexp: "^prefix=", line: "prefix=/usr/local" } }

  # 1700. Wine
  - { name: "Wine: Import GPG key", become: yes, apt_key: { id: "{{ wine_gpg_key_id }}", url: "https://dl.winehq.org/wine-builds/winehq.key" } }
  - { name: "Wine: Add repository", become: yes, apt_repository: { repo: "deb https://dl.winehq.org/wine-builds/ubuntu/ {{ ansible_distribution_release }} main", update_cache: yes } }
  # Ubuntu 18.04 does not provide FAudio, which is a dependency of current Wine. (FAudio packages for Ubuntu 19.10 and later are in the distro's universe repository)
  # Following the instructions in https://forum.winehq.org/viewtopic.php?f=8&t=32192 to install FAudio from the OBS
  - { name: "Wine: Add openSUSE GPG key", become: yes, apt_key: { id: "5104960E", url: "https://download.opensuse.org/repositories/Emulators:/Wine:/Debian/xUbuntu_18.04/Release.key" }, when: "ansible_distribution_version is version('18.04', '==')", tags: [wine] }
  - { name: "Wine: Add openSUSE repository", become: yes, apt_repository: { repo: "deb https://download.opensuse.org/repositories/Emulators:/Wine:/Debian/xUbuntu_18.04/ ./", update_cache: yes }, when: "ansible_distribution_version is version('18.04', '==')", tags: [wine] }
  - { name: "Wine: Install packages", become: yes, apt: { pkg: [winehq-stable], state: present } }
  # 1750. PlayOnLinux
  - { name: "PlayOnLinux: Import GPG key", become: yes, apt_key: { id: "{{ playonlinux_gpg_key_id }}", url: "http://deb.playonlinux.com/public.gpg" } }
  - { name: "PlayOnLinux: Add repository", become: yes, apt_repository: { repo: "deb http://deb.playonlinux.com/ {{ ansible_distribution_release }} main", update_cache: yes } }
  - { name: "PlayOnLinux: Install packages", become: yes, apt: { pkg: [playonlinux], state: present } }
  # 1760. QEMU
  - { name: "QEMU: Install prerequisites", become: yes, apt: { pkg: [bison, flex, libpixman-1-dev, libudev-dev], state: present }, tags: [qemu] }
  - { name: "QEMU: Check installation", become: yes, command: "ls /opt/qemu-{{ qemu_version }}", register: qemu_install_query, changed_when: no, failed_when: no, tags: [qemu] }
  - { name: "QEMU: Download source", get_url: { url: "https://download.qemu.org/qemu-{{ qemu_version }}.tar.xz", dest: "/tmp/qemu-{{ qemu_version }}.tar.xz", checksum: "{{ qemu_checksum }}" }, when: "qemu_install_query.rc > 0", tags: [qemu] }
  - { name: "QEMU: Compile & install packages", when: "qemu_install_query.rc > 0",
      shell: "cd /tmp && tar --overwrite -Jxf 'qemu-{{ qemu_version }}.tar.xz' && cd 'qemu-{{ qemu_version }}' && ./configure --prefix='/opt/qemu-{{ qemu_version }}' && make -j8 && make install", tags: [qemu] }
  - { name: "QEMU: Capture available systems", command: "find /opt/qemu-{{ qemu_version }}/bin -type f -perm -u=x -printf '%f\\n'", register: qemu_installed_systems, changed_when: no, tags: [qemu] }
    # => (for 4.0.0)
    # qemu-system-sh4 qemu-aarch64 qemu-system-riscv64 qemu-system-xtensaeb qemu-system-mips qemu-xtensa qemu-xtensaeb
    # qemu-img qemu-microblaze qemu-system-ppc64 qemu-ppc64 qemu-system-sparc qemu-sparc32plus qemu-system-cris
    # qemu-system-unicore32 qemu-system-nios2 elf2dmp qemu-system-ppc qemu-system-arm qemu-riscv32 qemu-nbd
    # ivshmem-server qemu-nios2 qemu-cris qemu-system-sh4eb qemu-system-tricore qemu-ga qemu-or1k qemu-m68k
    # qemu-system-riscv32 qemu-hppa qemu-riscv64 qemu-system-i386 qemu-mips64el qemu-system-m68k qemu-system-s390x
    # qemu-ppc qemu-x86_64 qemu-system-aarch64 qemu-sparc qemu-s390x qemu-system-hppa qemu-sparc64 qemu-arm
    # qemu-ppc64abi32 qemu-system-microblazeel qemu-sh4 qemu-pr-helper qemu-system-mips64 qemu-system-mips64el
    # qemu-mipsn32 qemu-system-microblaze qemu-system-alpha qemu-ppc64le qemu-mipsel qemu-system-moxie qemu-aarch64_be
    # qemu-alpha qemu-io qemu-system-xtensa qemu-tilegx ivshmem-client qemu-mips64 qemu-sh4eb qemu-system-sparc64
    # qemu-system-mipsel qemu-i386 qemu-mips qemu-microblazeel qemu-system-x86_64 qemu-edid qemu-system-lm32
    # qemu-system-or1k qemu-armeb qemu-mipsn32el
  - { name: "QEMU: Set up alternatives", become: yes, alternatives: { name: "{{ item }}", link: "/usr/local/bin/{{ item }}", path: "/opt/qemu-{{ qemu_version }}/bin/{{ item }}" }, tags: [qemu], with_items: "{{ qemu_installed_systems.stdout_lines }}" }
  - { name: "QEMU: Set permissions for bridge helper", become: yes, file: { path: "/opt/qemu-{{ qemu_version }}/libexec/qemu-bridge-helper", state: file, owner: "root", group: "{{ ansible_user_gid }}", mode: 'u=srwx,g=rx,o=' }, tags: [qemu] }
  - { name: "QEMU: Set up bridge helper alternative", become: yes, alternatives: { name: "qemu-bridge-helper", link: "/usr/local/bin/qemu-bridge-helper", path: "/opt/qemu-{{ qemu_version }}/libexec/qemu-bridge-helper" }, tags: [qemu] }

  # 1800. ffmpeg
  - { name: "ffmpeg: Check installation", become: yes, command: "ls /opt/ffmpeg-{{ ffmpeg_version }}", register: ffmpeg_install_query, changed_when: no, failed_when: no, tags: [ffmpeg] }
  - { name: "ffmpeg: Download static build", get_url: { url: "https://johnvansickle.com/ffmpeg/old-releases/ffmpeg-{{ ffmpeg_version }}-{{ ffmpeg_platform }}-static.tar.xz", dest: "/tmp/ffmpeg-{{ ffmpeg_version }}.tar.xz", checksum: "{{ ffmpeg_checksum }}" }, when: "ffmpeg_install_query.rc > 0", tags: [ffmpeg] }
  - { name: "ffmpeg: Unpack & install packages", when: "ffmpeg_install_query.rc > 0",
      shell: "cd /tmp && tar --overwrite -Jxf 'ffmpeg-{{ ffmpeg_version }}.tar.xz' && mv 'ffmpeg-{{ ffmpeg_version }}-{{ ffmpeg_platform }}-static' '/opt/ffmpeg-{{ ffmpeg_version }}'",
      tags: [ffmpeg] }
  - { name: "ffmpeg: Set up alternatives", become: yes, alternatives: { name: "{{ item }}", link: "/usr/local/bin/{{ item }}", path: "/opt/ffmpeg-{{ ffmpeg_version }}/{{ item }}" }, tags: [ffmpeg], with_items: [
      ffmpeg,
      ffprobe
    ] }

  # 1810. Tesseract OCR engine
  - { name: "Tesseract: Add PPA", become: yes, apt_repository: { repo: "ppa:alex-p/tesseract-ocr", update_cache: yes }, tags: [tesseract] }
  - name: "Tesseract: Pin packages priorities"
    become: yes
    copy:
      dest: '/etc/apt/preferences.d/tesseract-ocr'
      force: yes
      content: |
        ###
        ### DO NOT EDIT BY HAND, YOUR CHANGES WILL BE LOST!
        ###
        ### Adjust pin priority of packages and whitelist only certain packages from PPA `alex-p/tesseract-ocr`.

        Package: *
        Pin: release o=LP-PPA-alex-p-tesseract-ocr
        Pin-Priority: 400

        Package: tesseract* liblept5 libopenjp2-7 libtesseract4
        Pin: release o=LP-PPA-alex-p-tesseract-ocr
        Pin-Priority: 500
    register: tesseract_pin_priorities
    tags: [tesseract]
  - { name: "Tesseract: Update apt cache", become: yes, apt: { update_cache: yes }, when: tesseract_pin_priorities.changed, tags: [tesseract] }
  - { name: "Tesseract: Install packages", become: yes, apt: { pkg: "{{ ('tesseract-ocr tesseract-ocr-' + tesseract_languages|join(' tesseract-ocr-')).split(' ') }}", state: present }, tags: [tesseract] }

  # 1900. Authy Desktop
  #
  # See https://aur.archlinux.org/cgit/aur.git/tree/PKGBUILD?h=authy
  #
  - { name: "Authy: Install prerequisites", become: yes, apt: { pkg: [p7zip], state: present }, tags: [authy] }
  - { name: "Authy: Check installation", become: yes, command: "ls /opt/authy-{{ authy_desktop_version }}", register: authy_desktop_install_query, changed_when: no, failed_when: no, tags: [authy] }
  - { name: "Authy: Download Windows installer", get_url: { url: "https://s3.amazonaws.com/authy-electron-repository-production/authy/stable/{{ authy_desktop_version }}/win32/x64/Authy%20Desktop%20Setup%20{{ authy_desktop_version }}.exe", dest: "/tmp/AuthyDesktopSetup{{ authy_desktop_version }}.exe", checksum: "{{ authy_desktop_checksum }}" }, when: "authy_desktop_install_query.rc > 0", tags: [authy] }
  - name: "Authy: Extract & install Electron app"
    when: "authy_desktop_install_query.rc > 0"
    shell: |
      cd /tmp &&
      7z x "AuthyDesktopSetup{{ authy_desktop_version }}.exe" -o"authy-{{ authy_desktop_version }}" -y &&
      cd "authy-{{ authy_desktop_version }}" &&
      7z x "authy-electron-{{ authy_desktop_version }}-full.nupkg" -y &&
      mkdir -p app &&
      npx -q asar@2 e lib/net45/resources/app.asar app &&
      cd app &&
      npx -q yarn@1.22 add electron@8 &&
      cp -R "/tmp/authy-{{ authy_desktop_version }}/app" /opt/authy-{{ authy_desktop_version }}
    args: { executable: "/bin/bash" }
    tags: [authy]
  - name: "Authy: Add desktop icon"
    become: yes
    copy:
      dest: "/usr/share/applications/authy.desktop"
      content: |
        [Desktop Entry]
        Version={{ authy_desktop_version }}
        Type=Application
        Terminal=false
        Exec=/opt/authy-{{ authy_desktop_version }}/node_modules/electron/dist/electron /opt/authy-{{ authy_desktop_version }}/
        Name=Authy
        Comment=Two-Factor Authentication
        Icon=/opt/authy-{{ authy_desktop_version }}/img/logos/icon128.png
        StartupWMClass=Authy Desktop
    tags: [authy]

  # 1950. Android Studio
  - { name: "Android Studio: Check installation", become: yes, command: "ls /opt/android-studio-{{ android_studio_version }}-{{ android_studio_build }}", register: android_studio_install_query, changed_when: no, failed_when: no, tags: [android] }
  - { name: "Android Studio: Download Android Studio", get_url: { url: "https://dl.google.com/dl/android/studio/ide-zips/{{ android_studio_version }}/android-studio-ide-{{ android_studio_build }}-linux.tar.gz", dest: "/tmp/android-studio-{{ android_studio_version }}-{{ android_studio_build }}.tar.gz", checksum: "{{ android_studio_checksum }}" }, when: "android_studio_install_query.rc > 0", tags: [android] }
  - { name: "Android Studio: Install Android Studio", shell: "cd /tmp && tar --overwrite -zxf 'android-studio-{{ android_studio_version }}-{{ android_studio_build }}.tar.gz' && mv ./android-studio '/opt/android-studio-{{ android_studio_version }}-{{ android_studio_build }}'", when: "android_studio_install_query.rc > 0", tags: [android] }
  - name: "Android Studio: Add desktop icon"
    copy:
      dest: "{{ ansible_env.HOME }}/.local/share/applications/android-studio.desktop"
      content: |
        [Desktop Entry]
        Version=1.0
        Type=Application
        Name=Android Studio
        Exec=/opt/android-studio-{{ android_studio_version }}-{{ android_studio_build }}/bin/studio.sh %f
        Icon=/opt/android-studio-{{ android_studio_version }}-{{ android_studio_build }}/bin/studio.png
        Comment=The official Android IDE
        Categories=Development;IDE;
        Terminal=false
        StartupNotify=true
        StartupWMClass=jetbrains-studio
        MimeType=application/x-extension-iml;
    tags: [android]
  - { name: "Android Studio: Capture local Zsh configuration", shell: 'echo ".localrc_`uname -n`_`uname -o 2>/dev/null || echo Darwin`" | tr "[A-Z]" "[a-z]" | tr "/" "_"', args: { executable: "/bin/bash" }, register: android_studio_localrc, changed_when: no, failed_when: no, tags: [android] }
  - name: "Android Studio: Update Zsh configuration"
    blockinfile:
      marker: "### {mark} AUTOMATICALLY GENERATED"
      block: |
        ###
        ### DO NOT EDIT BY HAND, YOUR CHANGES WILL BE LOST!
        ###
        export ANDROID_HOME="${ANDROID_HOME-{{ android_home }}}"
        export PATH="${PATH}:${ANDROID_HOME}/platform-tools:${ANDROID_HOME}/tools"
      create: yes
      insertafter: EOF
      path: "{{ ansible_env.HOME }}/{{ android_studio_localrc.stdout }}"
    tags: [android]

  # 2000. InfoNotary: qualified electronic signature used when paying bills, accessing tax statements, etc.
  #
  # - 'bit4id-ipki' - driver for Bit4id smart cards.
  # - 'pcsc-omnikey' - driver for OmniKey readers.
  # - 'infonotary-client-software' - software for management of smart cards.
  #
  - { name: "InfoNotary: Import GPG key", become: yes, apt_key: { id: "3D4B1879", url: "https://repository.infonotary.com/install/linux/INotaryCodeSigningD.key.asc" } }
  - { name: "InfoNotary: Add repository", become: yes, apt_repository: { repo: "deb http://repository.infonotary.com/install/linux/DEBS/ any non-free", update_cache: yes } }
  - { name: "InfoNotary: Install packages", become: yes, apt: { pkg: [bit4id-ipki, pcsc-omnikey, infonotary-client-software], state: present } }
  - { name: "InfoNotary: Create Firefox certificate", become: yes, copy: { dest: "/usr/lib/mozilla/certificates/{{ item }}", src: "certificates/{{ item }}", owner: "{{ ansible_user_id }}", mode: 0444, force: yes }, with_items: [
      InfoNotaryQualifiedLegalPersonSealCA.pem,
      InfoNotaryQualifiedPersonalSignCA.pem,
      InfoNotaryQualifiedTimeStampingServiceCA.pem,
      InfoNotaryQualifiedValidatedDomainCA.pem,
      InfoNotaryQualifiedValidationServicesCA.pem,
      InfoNotaryTSPRoot.pem
    ] }

  # 2010. ufw
  - { name: "ufw: Install packages", become: yes, apt: { pkg: [ufw], state: present }, tags: [ufw] }
  - { name: "ufw: Configure defaults", become: yes, ufw: { direction: "{{ item.direction }}", policy: "{{ item.policy }}" }, with_items: "{{ ufw_policy }}", notify: "ufw::restart", tags: [ufw] }
  - { name: "ufw: Configure rules", become: yes, ufw: "{{ item }}", with_items: "{{ ufw_rules }}", notify: "ufw::restart", tags: [ufw] }
  - { name: "ufw: Enable logging", become: yes, ufw: { logging: on }, notify: "ufw::restart", tags: [ufw] }
  - { name: "ufw: Allow VPN PPTP connections", become: yes, lineinfile: { path: "/etc/ufw/before.rules", regexp: "-p\\s+47\\b", line: "-A ufw-before-input -p 47 -j ACCEPT", insertbefore: "drop INVALID packets" }, tags: [ufw] }
  - { name: "ufw: Turn on", become: yes, ufw: { state: enabled }, tags: [ufw] }

  # 2020. SSH+mosh
  - { name: "SSH: Install packages", become: yes, apt: { pkg: [openssh-server], state: present }, tags: [ssh] }
  - { name: "SSH: Configure daemon", become: yes, lineinfile: { dest: /etc/ssh/sshd_config, regexp: "^[#\\s]*{{ item.key }}(?!\\.)\\b", line: "{{ item.key }}	{{ item.value }}", insertafter: EOF, state: present }, with_dict: "{{ sshd_config }}", notify: "sshd::restart", tags: [ssh] }
  - { name: "SSH: Prune host keys", become: yes, lineinfile: { dest: /etc/ssh/sshd_config, regexp: "^[#\\s]*HostKey\\s+(?!(\\/etc\\/ssh\\/ssh_host_{{ sshd_host_keys | join('_key|\\/etc\\/ssh\\/ssh_host_') }}_key))", state: absent }, notify: "sshd::restart", tags: [ssh] }
  - { name: "SSH: Configure host keys", become: yes, lineinfile: { dest: /etc/ssh/sshd_config, regexp: "^[#\\s]*HostKey\\s+/etc/ssh/ssh_host_{{ item }}_key", line: "HostKey	/etc/ssh/ssh_host_{{ item }}_key", state: present, insertafter: "^(Port|HostKey)\\b" }, with_items: "{{ sshd_host_keys }}", notify: "sshd::restart", tags: [ssh] }
  - { name: "PAM: Google Authenticator: Install prerequisites", become: yes, apt: { pkg: [checkinstall, libqrencode3, libpam0g-dev], state: present }, tags: [ssh, pam] }
  - { name: "PAM: Google Authenticator: Check installation", become: yes, shell: "{{ dpkg_query | format('libpam-google-authenticator') }}", register: pam_google_authenticator_dpkg_query, changed_when: no, failed_when: no, tags: [ssh, pam] }
  - { name: "PAM: Google Authenticator: Download", get_url: { url: "https://github.com/google/google-authenticator-libpam/archive/{{ pam_google_authenticator_version }}.tar.gz", dest: "/tmp/google-authenticator-libpam-{{ pam_google_authenticator_version }}.tar.gz", checksum: "{{ pam_google_authenticator_checksum }}" }, when: "pam_google_authenticator_dpkg_query.rc > 0", tags: [ssh, pam] }
  - name: "PAM: Google Authenticator: Compile & install package"
    become: yes
    when: "pam_google_authenticator_dpkg_query.rc > 0"
    shell: |
      cd /tmp &&
      tar --overwrite -zxf 'google-authenticator-libpam-{{ pam_google_authenticator_version }}.tar.gz' &&
      cd 'google-authenticator-libpam-{{ pam_google_authenticator_version }}' &&
      autoreconf -i &&
      ./configure --prefix='/usr/local' &&
      make && checkinstall -y --install=no \
        --maintainer 'stanimir@angeloff.name' \
        --pkgname 'libpam-google-authenticator' \
        --pkgversion '{{ pam_google_authenticator_version }}' \
        --pkgrelease 1 \
        --pkglicense 'Apache License, Version 2.0' \
        --requires libqrencode3,libpam0g &&
      dpkg -i 'libpam-google-authenticator_{{ pam_google_authenticator_version }}-'*.deb
    args: { executable: "/bin/bash" }
    tags: [ssh, pam]
  - { name: "PAM: Google Authenticator: Check system installation", become: yes, command: "apt-mark showhold", register: pam_google_authenticator_system_install_query, changed_when: no, failed_when: no, tags: [pam] }
  - { name: "PAM: Google Authenticator: Hold system packages", become: yes, when: "'libpam-google-authenticator' not in pam_google_authenticator_system_install_query.stdout", command: "apt-mark hold libpam-google-authenticator", tags: [pam] }
  - { name: "", become: yes, when: "'libpam-google-authenticator' not in pam_google_authenticator_system_install_query.stdout", command: "apt-mark hold libpam-google-authenticator", tags: [pam] }
  - name: "PAM: Notify: Add script"
    tags: [ssh, pam]
    copy:
      dest: '/usr/local/bin/pam-notify-ssh-open-session'
      owner: "{{ ansible_user_id }}"
      mode: 'u=rwx,g=rx,o=rx'
      force: yes
      content: |
        #!/bin/sh
        set -x
        [ "$PAM_TYPE" = "open_session" ] || exit 0
        if [ -z "$DBUS_SESSION_BUS_ADDRESS" ]; then
          pgrep 'gnome-session' -u "$PAM_USER" | while read -r pid; do
            dbus_env="$( cat /proc/"$pid"/environ | grep -z '^DBUS_SESSION_BUS_ADDRESS=' )"
            if [ -n "$dbus_env" ]; then
              su -s /bin/sh -c "export $dbus_env ; exec notify-send -u critical -t 30000 -i system-log-out \"A new '$PAM_SERVICE' session was opened by\" \"$PAM_USER (on `date` from $PAM_RHOST)\"" "$PAM_USER"
            fi
          done
        else
          notify-send -u critical -t 30000 -i system-log-out "A new '$PAM_SERVICE' session was opened by" "$PAM_USER (on `date` from $PAM_RHOST)"
        fi
  - { name: "SSH: Configure PAM", become: yes, lineinfile: { dest: /etc/pam.d/sshd, regexp: "^[#\\s]*{{ item.service }}\\s+{{ item.control }}\\s+.*{{ item.path | basename }}\\b", line: "{{ item.service }}	{{ item.control }}	{{ item.path }}{% if 'arguments' in item %}	{{ item.arguments }}{% endif %}", insertafter: EOF, state: present }, notify: "sshd::restart", tags: [ssh], with_items: [
      # See http://manpages.ubuntu.com/manpages/cosmic/en/man5/pam.d.5.html
      { service: auth, control: required, path: /usr/local/lib/security/pam_google_authenticator.so, arguments: 'echo_verification_code grace_period=3600' },
      { service: session, control: optional, path: pam_exec.so, arguments: '/usr/local/bin/pam-notify-ssh-open-session' }
    ] }
  - { name: "SSH: Override ufw rules", become: yes, lineinfile: { dest: /etc/ufw/applications.d/openssh-server, regexp: "^[#\\s]*ports\\s*=", line: "ports={{ sshd_config.Port | default(22) }}/tcp", state: present }, notify: "ufw::restart", tags: [ssh] }
  - { name: "SSH: Configure ufw rules", become: yes, ufw: { rule: allow, name: OpenSSH, comment: 'Allow ports used by the OpenSSH server.' }, notify: "ufw::restart", tags: [ssh] }
  - { name: "Mosh: Install prerequisites", become: yes, apt: { pkg: [perl, protobuf-compiler, libprotobuf-dev, libncurses5-dev, zlib1g-dev, libutempter-dev, libssl-dev], state: present }, tags: [mosh] }
  - { name: "Mosh: Check installation", become: yes, command: "ls /opt/mosh-{{ mosh_version }}", register: mosh_install_query, changed_when: no, failed_when: no, tags: [mosh] }
  - { name: "Mosh: Download source", get_url: { url: "https://mosh.org/mosh-{{ mosh_version }}.tar.gz", dest: "/tmp/mosh-{{ mosh_version }}.tar.gz", checksum: "{{ mosh_checksum }}" }, when: "mosh_install_query.rc > 0", tags: [mosh] }
  - name: "Mosh: Compile & install packages"
    when: "mosh_install_query.rc > 0"
    shell: |
      cd /tmp &&
      tar --overwrite -zxf 'mosh-{{ mosh_version }}.tar.gz' &&
      cd 'mosh-{{ mosh_version }}' &&
      ./configure --prefix='/opt/mosh-{{ mosh_version }}' --enable-hardening --enable-client --enable-server --enable-ufw --with-utempter --with-ncurses &&
      make && make install
    args: { executable: "/bin/bash" }
    tags: [mosh]
  - { name: "Mosh: Set up alternatives", become: yes, alternatives: { name: "{{ item }}", link: "/usr/local/bin/{{ item }}", path: "/opt/mosh-{{ mosh_version }}/bin/{{ item }}" }, tags: [mosh], with_items: [
      mosh,
      mosh-client,
      mosh-server
    ] }
  - { name: "Mosh: Copy ufw application profile", become: yes, copy: { src: "/opt/mosh-{{ mosh_version }}/etc/ufw/applications.d/mosh", dest: "/etc/ufw/applications.d/mosh", force: yes }, tags: [mosh] }
  - { name: "Mosh: Configure ufw rules", become: yes, ufw: { rule: allow, name: mosh, comment: 'Allow ports used by mosh-server.' }, notify: "ufw::restart", tags: [mosh] }

  # 3000. Communications
  - { name: "Rambox: Install AppImage", get_url: { url: "https://github.com/ramboxapp/community-edition/releases/download/{{ rambox_version }}/Rambox-{{ rambox_version }}-{{ rambox_platform }}.AppImage", dest: "/usr/local/bin/rambox", mode: "+x", checksum: "{{ rambox_checksum }}" }, tags: [rambox] }
  - { name: "Rambox: Download desktop icon", get_url: { url: "https://github.com/ramboxapp/community-edition/raw/{{ rambox_version }}/resources/logo/512x512.png", dest: "{{ ansible_env.HOME }}/.local/share/icons/appimagekit-rambox.png" }, tags: [rambox] }
  - name: "Rambox: Add desktop icon"
    copy:
      dest: "{{ ansible_env.HOME }}/.local/share/applications/appimagekit-rambox.desktop"
      content: |
        [Desktop Entry]
        Name=Rambox
        Exec="/usr/local/bin/rambox" %U
        Terminal=false
        Type=Application
        Icon=appimagekit-rambox
        StartupWMClass=Rambox
        X-AppImage-Version={{ rambox_version }}
        Categories=Network;
        Comment=Free and Open Source messaging and emailing app that combines common web applications into one.
    tags: [rambox]

  # 3100. Steam
  - { name: "Steam: Check installation", become: yes, shell: "{{ dpkg_query | format('steam-launcher') }}", register: steam_dpkg_query, changed_when: no, failed_when: no, tags: [steam] }
  - { name: "Steam: Download packages", get_url: { url: "http://repo.steampowered.com/steam/archive/precise/steam-launcher_{{ steam_launcher_version }}_all.deb", dest: "/tmp/steam-launcher-{{ steam_launcher_version }}.deb", checksum: "{{ steam_launcher_checksum }}" }, when: "steam_dpkg_query.rc > 0", tags: [steam] }
  - { name: "Steam: Install packages", become: yes, apt: { deb: "/tmp/steam-launcher-{{ steam_launcher_version }}.deb", state: present }, when: "steam_dpkg_query.rc > 0", tags: [steam] }

  # 3200. Fraidycat
  - { name: "Fraidycat: Install AppImage", get_url: { url: "https://github.com/kickscondor/fraidycat/releases/download/v{{ fraidycat_version }}/Fraidycat-{{ fraidycat_version }}.AppImage", dest: "/usr/local/bin/Fraidycat", mode: "+x", checksum: "{{ fraidycat_checksum }}" }, tags: [fraidycat] }
  - { name: "Fraidycat: Download desktop icon", get_url: { url: "https://github.com/kickscondor/fraidycat/raw/v{{ fraidycat_version }}/src/images/flatcat-512.png", dest: "{{ ansible_env.HOME }}/.local/share/icons/appimagekit-fraidycat.png" }, tags: [fraidycat] }
  - name: "Fraidycat: Add desktop icon"
    copy:
      dest: "{{ ansible_env.HOME }}/.local/share/applications/appimagekit-fraidycat.desktop"
      content: |
        [Desktop Entry]
        Name=Fraidycat
        Exec="/usr/local/bin/Fraidycat" %U
        Terminal=false
        Type=Application
        Icon=appimagekit-fraidycat
        StartupWMClass=Fraidycat
        X-AppImage-Version={{ fraidycat_version }}
        Comment=Follow blogs, wikis, YouTube, Twitter, Reddit, Instagram and the like... from a distance.
        Categories=News;
    tags: [fraidycat]

  # 5000. Post-install clean up & purging of packages
  #
  - { name: "Post-install: Clean packages", become: yes, apt: { pkg: "{{ lookup('file', 'apt.absent.txt').splitlines() | map('regex_replace', '#.*$', '') | map('trim') | select('regex', '.') | list }}", state: absent, autoremove: yes }, tags: [post-install] }
  - { name: "Post-install: Purge packages", become: yes, apt: { pkg: "{{ lookup('file', 'apt.purge.txt').splitlines() | map('regex_replace', '#.*$', '') | map('trim') | select('regex', '.') | list }}", state: absent, autoremove: yes, purge: true }, tags: [post-install] }

  # 5010. Scheduled jobs to tame caches
  - name: "Post-install: Clean up caches daily"
    become: yes
    tags: [cache]
    copy:
      dest: "/etc/cron.daily/99tame-caches"
      owner: "{{ ansible_user_id }}"
      group: root
      mode: 0774
      force: yes
      content: |
        #!/bin/sh
        set -e
        {% set indent = "\t" %}
        {% set su = "su " + (ansible_user_id | quote) + " -c" %}
        if which composer 1>/dev/null 2>&1; then
        {{ indent }}{{ su }} "composer clear-cache -n --quiet" 1>/dev/null
        fi
        if which npm 1>/dev/null 2>&1; then
        {{ indent }}{{ su }} "npm cache clean --force --loglevel error" 1>/dev/null
        fi
        if which yarn 1>/dev/null 2>&1; then
        {{ indent }}{{ su }} "yarn cache clean" 1>/dev/null
        fi
        {% for directory in [".cache/bower", ".cache/pip"] %}
        if [ -d "{{ ansible_env.HOME }}/{{ directory }}" ]; then rm -Rf "{{ ansible_env.HOME }}/{{ directory }}" 1>/dev/null ; fi
        {% endfor %}

  - { import_tasks: flatpak.tasks.yml }


# vim: sw=2 ts=2 et :
